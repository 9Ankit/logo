/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { NSystemService } from './n-system.service';
import { Injectable } from '@angular/core';
import { NgForage, NgForageCache, NgForageConfig } from 'ngforage';
import { NUtility } from './n-util.service';
export class NLocalStorageService {
    /**
     * @param {?=} ngfConfig
     * @param {?=} ngf
     * @param {?=} ngfCache
     */
    constructor(ngfConfig, ngf, ngfCache) {
        this.ngfConfig = ngfConfig;
        this.ngf = ngf;
        this.ngfCache = ngfCache;
        this.storageCache = {};
    }
    /**
     * @return {?}
     */
    initStorage() {
        return new Promise((resolve, reject) => {
            if (window['cordova']) {
                this.initNgForage();
            }
            this.ngf.iterate((value, key, iteratonNumber) => {
                this.storageCache[key] = value;
            }).then(result => {
                this.checkDeviceId();
                return resolve('iteration is completed');
            }).catch(error => {
                return reject(error);
            });
        });
    }
    /**
     * @return {?}
     */
    getStorage() {
        return this.storageCache;
    }
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    setValue(key, value) {
        if (window['cordova']) {
            this.initNgForage();
        }
        this.storageCache[key] = value;
        return this.ngf.setItem(key, value).then(result => {
            return result;
        }, error => {
            console.log(error);
        });
    }
    /**
     * @param {?} key
     * @return {?}
     */
    getValue(key) {
        if (!this.storageCache[key]) {
            return null;
        }
        try {
            const /** @type {?} */ obj = this.storageCache[key];
            return JSON.parse(obj);
        }
        catch (/** @type {?} */ error) {
            return this.storageCache[key];
        }
    }
    /**
     * @param {?} key
     * @return {?}
     */
    remove(key) {
        delete this.storageCache[key];
        if (window['cordova']) {
            this.initNgForage();
        }
        this.ngf.removeItem(key).then(fulfilled => {
            delete this.ngf[key];
        }).catch(error => {
            console.error('Could not remove', key);
        });
    }
    /**
     * @return {?}
     */
    clear() {
        this.storageCache = {};
        this.ngf.clear();
    }
    /**
     * @return {?}
     */
    pluginCheck() {
        if (window['cordova'] && window['NativeStorage']) {
            this.nativeStorageI = window['NativeStorage'];
            // return true;
        }
        // this.initStorage();
    }
    /**
     * @param {?} key
     * @return {?}
     */
    getItemNs(key) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.getItem(key, result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    setItemNs(key, value) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.setItem(key, value, result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    /**
     * @param {?} key
     * @return {?}
     */
    removeItemNs(key) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.remove(key, (result) => {
                    resolve(result);
                }, (error) => {
                    reject(error);
                });
            }
        });
    }
    /**
     * @return {?}
     */
    clearNs() {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.clear(result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    /**
     * @return {?}
     */
    initNgForage() {
        this.ngfConfig.configure({
            name: 'MyApp',
            driver: [
                NgForageConfig.DRIVER_WEBSQL,
            ]
        });
    }
    /**
     * @param {?} promise
     * @return {?}
     */
    promiseReflect(promise) {
        return promise.then(resolved => { return { v: resolved, status: 'resolved' }; }, error => { return { e: error, status: 'rejected' }; });
    }
    /**
     * @return {?}
     */
    clearLocalStorage() {
        this.remove('userObj');
        this.remove('accessToken');
        this.remove('refreshToken');
        this.remove('registrationId');
    }
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
     * @return {?}
     */
    checkDeviceId() {
        if (NSystemService.getInstance().checkDevice() === 'browser') {
            this._deviceUUID = this.getValue('uuid');
            if (!this._deviceUUID) {
                this._deviceUUID = new NUtility().generateUUID();
                this.setValue('uuid', this._deviceUUID);
            }
        }
        else {
            window['plugins'].uniqueDeviceID.get((uuid) => {
                this._deviceUUID = uuid;
                this.setValue('uuid', this._deviceUUID);
            });
        }
        return this._deviceUUID;
    }
    /**
     * @return {?}
     */
    get deviceUUID() {
        return this._deviceUUID;
    }
}
NLocalStorageService.decorators = [
    { type: Injectable },
];
/** @nocollapse */
NLocalStorageService.ctorParameters = () => [
    { type: NgForageConfig, },
    { type: NgForage, },
    { type: NgForageCache, },
];
function NLocalStorageService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NLocalStorageService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NLocalStorageService.ctorParameters;
    /** @type {?} */
    NLocalStorageService.prototype.storageCache;
    /** @type {?} */
    NLocalStorageService.prototype._deviceUUID;
    /** @type {?} */
    NLocalStorageService.prototype.nativeStorageI;
    /** @type {?} */
    NLocalStorageService.prototype.ngfConfig;
    /** @type {?} */
    NLocalStorageService.prototype.ngf;
    /** @type {?} */
    NLocalStorageService.prototype.ngfCache;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2NhbFN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQWMsTUFBTSxVQUFVLENBQUM7QUFDL0UsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRzVDLE1BQU07Ozs7OztJQUtKLFlBQW9CLFNBQTBCLEVBQW1CLEdBQWMsRUFBbUIsUUFBd0I7UUFBdEcsY0FBUyxHQUFULFNBQVMsQ0FBaUI7UUFBbUIsUUFBRyxHQUFILEdBQUcsQ0FBVztRQUFtQixhQUFRLEdBQVIsUUFBUSxDQUFnQjs0QkFIdEcsRUFBRTtLQUlyQjs7OztJQUlELFdBQVc7UUFDVCxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3JCO1lBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLGNBQWMsRUFBRSxFQUFFO2dCQUM5QyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQzthQUNoQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUNmLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztn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LGFBQWE7UUFDWCxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUMsV0FBVyxFQUFFLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUNqRCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDekM7U0FDRjtRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7Z0JBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUN6QyxDQUFDLENBQUM7U0FDSjtRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO0tBQ3pCOzs7O1FBRVUsVUFBVTtRQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQzs7OztZQTNLM0IsVUFBVTs7OztZQUh1QixjQUFjO1lBQXZDLFFBQVE7WUFBRSxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgbG9jYWxmb3JhZ2UgZnJvbSAnbG9jYWxmb3JhZ2UnO1xuaW1wb3J0IHsgTmdGb3JhZ2UsIE5nRm9yYWdlQ2FjaGUsIE5nRm9yYWdlQ29uZmlnLCBDYWNoZWRJdGVtIH0gZnJvbSAnbmdmb3JhZ2UnO1xuaW1wb3J0IHsgTlV0aWxpdHkgfSBmcm9tICcuL24tdXRpbC5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIHtcblxuICBzdG9yYWdlQ2FjaGU6IGFueSA9IHt9O1xuICBwcml2YXRlIF9kZXZpY2VVVUlEO1xuICBwcml2YXRlIG5hdGl2ZVN0b3JhZ2VJO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nZkNvbmZpZz86IE5nRm9yYWdlQ29uZmlnLCBwcml2YXRlIHJlYWRvbmx5IG5nZj86IE5nRm9yYWdlLCBwcml2YXRlIHJlYWRvbmx5IG5nZkNhY2hlPzogTmdGb3JhZ2VDYWNoZSkge1xuICB9XG5cblxuXG4gIGluaXRTdG9yYWdlKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10pIHtcbiAgICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubmdmLml0ZXJhdGUoKHZhbHVlLCBrZXksIGl0ZXJhdG9uTnVtYmVyKSA9PiB7XG4gICAgICAgIHRoaXMuc3RvcmFnZUNhY2hlW2tleV0gPSB2YWx1ZTtcbiAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgdGhpcy5jaGVja0RldmljZUlkKCk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCdpdGVyYXRpb24gaXMgY29tcGxldGVkJylcbiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBnZXRTdG9yYWdlKCkge1xuICAgIHJldHVybiB0aGlzLnN0b3JhZ2VDYWNoZTtcbiAgfVxuXG5cbiAgc2V0VmFsdWUoa2V5LCB2YWx1ZSkge1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xuICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICB9XG4gICAgdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSA9IHZhbHVlO1xuICAgIHJldHVybiB0aGlzLm5nZi5zZXRJdGVtKGtleSwgdmFsdWUpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwgZXJyb3IgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgIH0pXG4gIH1cblxuICBnZXRWYWx1ZShrZXkpOiBhbnkgfCBQcm9taXNlPGFueT4ge1xuICAgIGlmICghdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSB0cnkge1xuICAgICAgY29uc3Qgb2JqID0gdGhpcy5zdG9yYWdlQ2FjaGVba2V5XVxuICAgICAgcmV0dXJuIEpTT04ucGFyc2Uob2JqKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZUNhY2hlW2tleV07XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGtleSkge1xuICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldO1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xuICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICB9XG4gICAgdGhpcy5uZ2YucmVtb3ZlSXRlbShrZXkpLnRoZW4oZnVsZmlsbGVkID0+IHtcbiAgICAgIGRlbGV0ZSB0aGlzLm5nZltrZXldO1xuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkIG5vdCByZW1vdmUnLCBrZXkpO1xuICAgIH0pXG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLnN0b3JhZ2VDYWNoZSA9IHt9O1xuICAgIHRoaXMubmdmLmNsZWFyKCk7XG4gIH1cblxuICBwcml2YXRlIHBsdWdpbkNoZWNrKCkge1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSSA9IHdpbmRvd1snTmF0aXZlU3RvcmFnZSddO1xuICAgICAgLy8gcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8vIHRoaXMuaW5pdFN0b3JhZ2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SXRlbU5zKGtleSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5nZXRJdGVtKGtleSwgcmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHNldEl0ZW1OcyhrZXksIHZhbHVlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLnNldEl0ZW0oa2V5LCB2YWx1ZSwgcmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUl0ZW1OcyhrZXkpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkucmVtb3ZlKGtleSwgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgY2xlYXJOcygpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkuY2xlYXIocmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGluaXROZ0ZvcmFnZSgpIHtcbiAgICB0aGlzLm5nZkNvbmZpZy5jb25maWd1cmUoe1xuICAgICAgbmFtZTogJ015QXBwJyxcbiAgICAgIGRyaXZlcjogW1xuICAgICAgICBOZ0ZvcmFnZUNvbmZpZy5EUklWRVJfV0VCU1FMLFxuICAgICAgXVxuICAgIH0pO1xuXG4gIH1cblxuICBwcml2YXRlIHByb21pc2VSZWZsZWN0KHByb21pc2UpIHtcbiAgICByZXR1cm4gcHJvbWlzZS50aGVuKHJlc29sdmVkID0+IHsgcmV0dXJuIHsgdjogcmVzb2x2ZWQsIHN0YXR1czogJ3Jlc29sdmVkJyB9IH0sIGVycm9yID0+IHsgcmV0dXJuIHsgZTogZXJyb3IsIHN0YXR1czogJ3JlamVjdGVkJyB9IH0pXG4gIH1cblxuICBjbGVhckxvY2FsU3RvcmFnZSgpIHtcbiAgICB0aGlzLnJlbW92ZSgndXNlck9iaicpO1xuICAgIHRoaXMucmVtb3ZlKCdhY2Nlc3NUb2tlbicpO1xuICAgIHRoaXMucmVtb3ZlKCdyZWZyZXNoVG9rZW4nKTtcbiAgICB0aGlzLnJlbW92ZSgncmVnaXN0cmF0aW9uSWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEdWUgdG8gdGltaW5nIGlzc3VlcyBhbmQgY2lyY3VsYXIgZGVwZW5kZW5jeSBjaGVja0RldmljZUlkIGlzIG1vdmVkIGZyb20gTlN5c3RlbVNlcnZpY2VcbiAgKi9cblxuICBjaGVja0RldmljZUlkKCkge1xuICAgIGlmIChOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpLmNoZWNrRGV2aWNlKCkgPT09ICdicm93c2VyJykge1xuICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IHRoaXMuZ2V0VmFsdWUoJ3V1aWQnKTtcblxuICAgICAgaWYgKCF0aGlzLl9kZXZpY2VVVUlEKSB7XG4gICAgICAgIHRoaXMuX2RldmljZVVVSUQgPSBuZXcgTlV0aWxpdHkoKS5nZW5lcmF0ZVVVSUQoKTtcbiAgICAgICAgdGhpcy5zZXRWYWx1ZSgndXVpZCcsIHRoaXMuX2RldmljZVVVSUQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB3aW5kb3dbJ3BsdWdpbnMnXS51bmlxdWVEZXZpY2VJRC5nZXQoKHV1aWQpID0+IHtcbiAgICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IHV1aWQ7XG4gICAgICAgIHRoaXMuc2V0VmFsdWUoJ3V1aWQnLCB0aGlzLl9kZXZpY2VVVUlEKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlVVVJRDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGV2aWNlVVVJRCgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlVVVJRDtcbiAgfVxufVxuIl19