/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs/Observable';
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
export class NDataModelService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.invalidDataModelName = 'Invalid data model name.';
        this.invalidDataModelId = 'Invalid data model id.';
        this.invalidDataModelObj = 'Invalid data model object.';
        this.systemService = NSystemService.getInstance();
    }
    /**
     *
     * @param {?} dataModelName
     * @param {?=} filter The filter query parameter allows to specify conditions on the documents to return.
     * The filter qparam value is any mongodb queryâ€¦ Defaults to {}
     * @param {?=} keys Projections to be applited on mongo db.
     * @param {?=} sort sort to be applied on the query results. Defaults to {}
     * @param {?=} pagenumber Page number for paginated queries. Defaults to 1
     * @param {?=} pagesize Size of each page to be returned. Defaults to 100.
     * @return {?}
     */
    get(dataModelName, filter, keys, sort, pagenumber, pagesize) {
        if (dataModelName) {
            // let modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            let /** @type {?} */ modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            if (this.checkIfValid(filter) || this.checkIfValid(keys) || this.checkIfValid(sort) ||
                this.checkIfValid(pagenumber) || this.checkIfValid(pagesize)) {
                let /** @type {?} */ queryString = `${this.toQueryString({
                    'filter': filter,
                    'keys': keys,
                    'sort': sort,
                    'pagenumber': pagenumber,
                    'pagesize': pagesize
                })}`;
                if (queryString === '') {
                    queryString += '?filter={}';
                }
                else {
                    queryString = '?'.concat(queryString);
                }
                modelNameUrl += queryString;
            }
            return this.http.get(modelNameUrl).map((value, index) => {
                return value;
            }).catch(error => {
                return Observable.throw(error);
            });
        }
        else {
            return Observable.throw(new Error(`Could not get ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    /**
     *
     * @param {?} dataModelName Data model name of the app
     * @param {?} dataModelObj Data Model object which is to be inserted
     * @return {?}
     */
    put(dataModelName, dataModelObj) {
        if (dataModelName) {
            if (dataModelObj) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
                const /** @type {?} */ modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
                return this.http.put(modelNameUrl, dataModelObj).map((value, index) => {
                    return value;
                }).catch(error => {
                    return Observable.throw(error);
                });
            }
            else {
                return Observable.throw(new Error(`Could not put ${dataModelObj} in ${dataModelName}. ${this.invalidDataModelObj}`));
            }
        }
        else {
            return Observable.throw(new Error(`Could not put ${dataModelObj} in ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    /**
     *
     * @param {?} dataModelName
     * @param {?} filter
     * @return {?}
     */
    delete(dataModelName, filter) {
        let /** @type {?} */ modelNameUrl;
        if (dataModelName) {
            // modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            if (this.checkIfValid(filter) && filter != '') {
                modelNameUrl += `?filter=${filter}`;
            }
            else {
                modelNameUrl += '?filter={}';
            }
            return this.http.delete(modelNameUrl).map((value, index) => {
                return value;
            }).catch(error => {
                return Observable.throw(error);
            });
        }
        else {
            return Observable.throw(new Error(`Could not delete ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    /**
     *
     * @param {?} dataModelName Data model name which is to be updated
     * @param {?} updateObject
     * @return {?}
     */
    update(dataModelName, updateObject) {
        if (dataModelName && updateObject) {
            // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}`;
            const /** @type {?} */ modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName;
            return this.http.patch(modelNameUrl, updateObject).map((value, index) => {
                return value;
            }).catch(error => {
                return Observable.throw(error);
            });
        }
        else {
            return Observable.throw(new Error(`Could not update ${dataModelName}. ${this.invalidDataModelName}`));
        }
    }
    /**
     *
     * @param {?} dataModelName Data model name which is to be updated
     * @param {?} dataModelId Data model id which is to be updated
     * @return {?}
     */
    getById(dataModelName, dataModelId) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                const /** @type {?} */ modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                return this.http.get(modelNameUrl).map((value, index) => {
                    return value;
                }).catch(error => {
                    return Observable.throw(error);
                });
            }
            else {
                Observable.throw(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelId}`));
            }
        }
        else {
            Observable.throw(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelName}`));
        }
    }
    /**
     *
     * @param {?} dataModelName Data model name which is to be deleted
     * @param {?} dataModelId Data model id which is to be deleted
     * @return {?}
     */
    deleteById(dataModelName, dataModelId) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                const /** @type {?} */ modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                return this.http.delete(modelNameUrl).map((value, index) => {
                    return value;
                }).catch(error => {
                    return Observable.throw(error);
                });
            }
            else {
                Observable.throw(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelId}`));
            }
        }
        else {
            return Observable.throw(new Error(`Could not delete ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelName}`));
        }
    }
    /**
     *
     * @param {?} dataModelName Data model name which is to be update
     * @param {?} dataModelId Data model id which is to be updated
     * @param {?} dataModelObj Data Model object which is to be inserted
     * @return {?}
     */
    updateById(dataModelName, dataModelId, dataModelObj) {
        if (dataModelName) {
            if (dataModelId) {
                // const modelNameUrl = `${this.getDataSourceURL(dataModelName)}${dataModelName}/${dataModelId}`;
                const /** @type {?} */ modelNameUrl = this.getDataSourceURL(dataModelName) + dataModelName + "/" + dataModelId;
                var /** @type {?} */ dmObj = Object.assign({}, dataModelObj);
                delete dmObj['_id'];
                return this.http.patch(modelNameUrl, dmObj).map((value, index) => {
                    return value;
                }).catch(error => {
                    return Observable.throw(error);
                });
            }
            else {
                Observable.throw(new Error(`Could not get ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelId}`));
            }
        }
        else {
            return Observable.throw(new Error(`Could not delete ${dataModelName} by id ${dataModelId}. ${this.invalidDataModelName}`));
        }
    }
    /**
     * @param {?} obj
     * @return {?}
     */
    toQueryString(obj) {
        const /** @type {?} */ parts = [];
        for (const /** @type {?} */ i in obj) {
            if (obj.hasOwnProperty(i) && this.checkIfValid(obj[i])) {
                parts.push((i) + '=' + JSON.stringify(obj[i]));
            }
        }
        return parts.join('&');
    }
    /**
     * @param {?} value
     * @return {?}
     */
    checkIfValid(value) {
        if (value === undefined || value == null) {
            return false;
        }
        else {
            return true;
        }
    }
    /**
     * @param {?} dataModelName
     * @return {?}
     */
    getDataSourceURL(dataModelName) {
        if (!this.dmDs) {
            this.dmDs = window['neutrinos']['dataSource'];
        }
        const /** @type {?} */ dsDm = this.dmDs[dataModelName];
        const /** @type {?} */ properties = this.systemService.properties;
        if (dsDm) {
            return properties.baseUrl + properties.tenantName + '/datamodel/' + dsDm + '/' + properties.appName + '/';
        }
        else {
            return this.systemService.getDataModelUrl();
        }
    }
}
NDataModelService.decorators = [
    { type: Injectable },
];
/** @nocollapse */
NDataModelService.ctorParameters = () => [
    { type: HttpClient, },
];
function NDataModelService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NDataModelService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NDataModelService.ctorParameters;
    /** @type {?} */
    NDataModelService.prototype.systemService;
    /** @type {?} */
    NDataModelService.prototype.dmUrl;
    /** @type {?} */
    NDataModelService.prototype.invalidDataModelName;
    /** @type {?} */
    NDataModelService.prototype.invalidDataModelId;
    /** @type {?} */
    NDataModelService.prototype.invalidDataModelObj;
    /** @type {?} */
    NDataModelService.prototype.dmDs;
    /** @type {?} */
    NDataModelService.prototype.http;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1kYXRhTW9kZWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWRhdGFNb2RlbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR3BELE1BQU07Ozs7SUFPSixZQUFvQixJQUFnQjtRQUFoQixTQUFJLEdBQUosSUFBSSxDQUFZO29DQUpHLDBCQUEwQjtrQ0FDNUIsd0JBQXdCO21DQUN2Qiw0QkFBNEI7UUFHaEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7S0FDbkQ7Ozs7Ozs7Ozs7OztJQWFELEdBQUcsQ0FBQyxhQUFhLEVBQUUsTUFBTyxFQUFFLElBQUssRUFBRSxJQUFLLEVBQUUsVUFBVyxFQUFFLFFBQVM7UUFDOUQsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzs7WUFFbEIscUJBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsR0FBRyxhQUFhLENBQUM7WUFDeEUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDO2dCQUNqRixJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUMs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QyxDQUFDO2FBQ2hEO1NBQ0Y7UUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzs7Ozs7O0lBR2pCLFlBQVksQ0FBQyxLQUFVO1FBQzdCLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDekMsTUFBTSxDQUFDLEtBQUssQ0FBQztTQUNkO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsSUFBSSxDQUFDO1NBQ2I7Ozs7OztJQUdLLGdCQUFnQixDQUFDLGFBQWE7UUFDcEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQy9DO1FBQ0QsdUJBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdEMsdUJBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDO1FBQ2pELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDVCxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsVUFBVSxHQUFHLGFBQWEsR0FBRyxJQUFJLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO1NBQzNHO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUM3Qzs7OztZQW5PSixVQUFVOzs7O1lBTEYsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5TeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi9uLXN5c3RlbS5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5EYXRhTW9kZWxTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzeXN0ZW1TZXJ2aWNlOiBOU3lzdGVtU2VydmljZTtcbiAgcHJpdmF0ZSBkbVVybDogc3RyaW5nO1xuICBwcml2YXRlIGludmFsaWREYXRhTW9kZWxOYW1lOiBzdHJpbmcgPSAnSW52YWxpZCBkYXRhIG1vZGVsIG5hbWUuJztcbiAgcHJpdmF0ZSBpbnZhbGlkRGF0YU1vZGVsSWQ6IHN0cmluZyA9ICdJbnZhbGlkIGRhdGEgbW9kZWwgaWQuJztcbiAgcHJpdmF0ZSBpbnZhbGlkRGF0YU1vZGVsT2JqOiBzdHJpbmcgPSAnSW52YWxpZCBkYXRhIG1vZGVsIG9iamVjdC4nO1xuICBwcml2YXRlIGRtRHM7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge1xuICAgIHRoaXMuc3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gIH1cblxuICAvLyBHRVQgL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX1cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lXG4gICAqIEBwYXJhbSBmaWx0ZXIgVGhlIGZpbHRlciBxdWVyeSBwYXJhbWV0ZXIgYWxsb3dzIHRvIHNwZWNpZnkgY29uZGl0aW9ucyBvbiB0aGUgZG9jdW1lbnRzIHRvIHJldHVybi5cbiAgICogVGhlIGZpbHRlciBxcGFyYW0gdmFsdWUgaXMgYW55IG1vbmdvZGIgcXVlcnnigKYgRGVmYXVsdHMgdG8ge31cbiAgICogQHBhcmFtIGtleXMgUHJvamVjdGlvbnMgdG8gYmUgYXBwbGl0ZWQgb24gbW9uZ28gZGIuXG4gICAqIEBwYXJhbSBzb3J0IHNvcnQgdG8gYmUgYXBwbGllZCBvbiB0aGUgcXVlcnkgcmVzdWx0cy4gRGVmYXVsdHMgdG8ge31cbiAgICogQHBhcmFtIHBhZ2VudW1iZXIgUGFnZSBudW1iZXIgZm9yIHBhZ2luYXRlZCBxdWVyaWVzLiBEZWZhdWx0cyB0byAxXG4gICAqIEBwYXJhbSBwYWdlc2l6ZSBTaXplIG9mIGVhY2ggcGFnZSB0byBiZSByZXR1cm5lZC4gRGVmYXVsdHMgdG8gMTAwLlxuICAgKi9cbiAgZ2V0KGRhdGFNb2RlbE5hbWUsIGZpbHRlcj8sIGtleXM/LCBzb3J0PywgcGFnZW51bWJlcj8sIHBhZ2VzaXplPyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcbiAgICAgIC8vIGxldCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfWA7XG4gICAgICBsZXQgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZTtcbiAgICAgIGlmICh0aGlzLmNoZWNrSWZWYWxpZChmaWx0ZXIpIHx8IHRoaXMuY2hlY2tJZlZhbGlkKGtleXMpIHx8IHRoaXMuY2hlY2tJZlZhbGlkKHNvcnQpIHx8XG4gICAgICAgIHRoaXMuY2hlY2tJZlZhbGlkKHBhZ2VudW1iZXIpIHx8IHRoaXMuY2hlY2tJZlZhbGlkKHBhZ2VzaXplKSkge1xuICAgICAgICBsZXQgcXVlcnlTdHJpbmcgPSBgJHt0aGlzLnRvUXVlcnlTdHJpbmcoe1xuICAgICAgICAgICdmaWx0ZXInOiBmaWx0ZXIsXG4gICAgICAgICAgJ2tleXMnOiBrZXlzLFxuICAgICAgICAgICdzb3J0Jzogc29ydCxcbiAgICAgICAgICAncGFnZW51bWJlcic6IHBhZ2VudW1iZXIsXG4gICAgICAgICAgJ3BhZ2VzaXplJzogcGFnZXNpemVcbiAgICAgICAgfSl9YDtcbiAgICAgICAgaWYgKHF1ZXJ5U3RyaW5nID09PSAnJykge1xuICAgICAgICAgIHF1ZXJ5U3RyaW5nICs9ICc/ZmlsdGVyPXt9JztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBxdWVyeVN0cmluZyA9ICc/Jy5jb25jYXQocXVlcnlTdHJpbmcpO1xuICAgICAgICB9XG4gICAgICAgIG1vZGVsTmFtZVVybCArPSBxdWVyeVN0cmluZztcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KG1vZGVsTmFtZVVybCkubWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3cobmV3IEVycm9yKGBDb3VsZCBub3QgZ2V0ICR7ZGF0YU1vZGVsTmFtZX0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XG4gICAgfVxuICB9XG5cbiAgLy8gUFVUIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9XG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgb2YgdGhlIGFwcFxuICAgKiBAcGFyYW0gZGF0YU1vZGVsT2JqIERhdGEgTW9kZWwgb2JqZWN0IHdoaWNoIGlzIHRvIGJlIGluc2VydGVkXG4gICAqL1xuICBwdXQoZGF0YU1vZGVsTmFtZSwgZGF0YU1vZGVsT2JqKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSkge1xuICAgICAgaWYgKGRhdGFNb2RlbE9iaikge1xuICAgICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfWA7XG4gICAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWU7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucHV0KG1vZGVsTmFtZVVybCwgZGF0YU1vZGVsT2JqKS5tYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycm9yKTtcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KG5ldyBFcnJvcihgQ291bGQgbm90IHB1dCAke2RhdGFNb2RlbE9ian0gaW4gJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxPYmp9YCkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhuZXcgRXJyb3IoYENvdWxkIG5vdCBwdXQgJHtkYXRhTW9kZWxPYmp9IGluICR7ZGF0YU1vZGVsTmFtZX0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XG4gICAgfVxuICB9XG5cbiAgLy8gREVMRVRFIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9XG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZVxuICAgKiBAcGFyYW0gZmlsdGVyXG4gICAqL1xuICBkZWxldGUoZGF0YU1vZGVsTmFtZSwgZmlsdGVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQgbW9kZWxOYW1lVXJsO1xuICAgIGlmIChkYXRhTW9kZWxOYW1lKSB7XG4gICAgICAvLyBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfWA7XG4gICAgICBtb2RlbE5hbWVVcmwgPSB0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkgKyBkYXRhTW9kZWxOYW1lO1xuXG4gICAgICBpZiAodGhpcy5jaGVja0lmVmFsaWQoZmlsdGVyKSAmJiBmaWx0ZXIgIT0gJycpIHtcbiAgICAgICAgbW9kZWxOYW1lVXJsICs9IGA/ZmlsdGVyPSR7ZmlsdGVyfWA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtb2RlbE5hbWVVcmwgKz0gJz9maWx0ZXI9e30nO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUobW9kZWxOYW1lVXJsKS5tYXAoKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycm9yKTtcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KG5ldyBFcnJvcihgQ291bGQgbm90IGRlbGV0ZSAke2RhdGFNb2RlbE5hbWV9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFBBVENIIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9XG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgd2hpY2ggaXMgdG8gYmUgdXBkYXRlZFxuICAgKiBAcGFyYW0gZGF0YU1vZGVsT2JqIE5ldyBkYXRhIG1vZGVsIG9iamVjdFxuICAgKi9cbiAgdXBkYXRlKGRhdGFNb2RlbE5hbWUsIHVwZGF0ZU9iamVjdCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKGRhdGFNb2RlbE5hbWUgJiYgdXBkYXRlT2JqZWN0KSB7XG4gICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfWA7XG4gICAgICBjb25zdCBtb2RlbE5hbWVVcmwgPSB0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSkgKyBkYXRhTW9kZWxOYW1lO1xuICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wYXRjaChtb2RlbE5hbWVVcmwsIHVwZGF0ZU9iamVjdCkubWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhuZXcgRXJyb3IoYENvdWxkIG5vdCB1cGRhdGUgJHtkYXRhTW9kZWxOYW1lfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxOYW1lfWApKTtcbiAgICB9XG4gIH1cblxuICAvLyBHRVQgL3t0ZW5hbnROYW1lfS9kYXRhbW9kZWwve2RhdGFzb3VyY2V9L3thcHBOYW1lfS97ZGF0YU1vZGVsTmFtZX0ve2RhdGFNb2RlbElkfVxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIGRhdGFNb2RlbE5hbWUgRGF0YSBtb2RlbCBuYW1lIHdoaWNoIGlzIHRvIGJlIHVwZGF0ZWRcbiAgICogQHBhcmFtIGRhdGFNb2RlbElkIERhdGEgbW9kZWwgaWQgd2hpY2ggaXMgdG8gYmUgdXBkYXRlZFxuICAgKi9cbiAgZ2V0QnlJZChkYXRhTW9kZWxOYW1lLCBkYXRhTW9kZWxJZCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcbiAgICAgIGlmIChkYXRhTW9kZWxJZCkge1xuICAgICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfS8ke2RhdGFNb2RlbElkfWA7XG4gICAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWUgKyBcIi9cIiArIGRhdGFNb2RlbElkO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldChtb2RlbE5hbWVVcmwpLm1hcCgodmFsdWUsIGluZGV4KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgT2JzZXJ2YWJsZS50aHJvdyhuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxJZH1gKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIE9ic2VydmFibGUudGhyb3cobmV3IEVycm9yKGBDb3VsZCBub3QgZ2V0ICR7ZGF0YU1vZGVsTmFtZX0gYnkgaWQgJHtkYXRhTW9kZWxJZH0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XG4gICAgfVxuICB9XG5cbiAgLy8gREVMRVRFIC97dGVuYW50TmFtZX0vZGF0YW1vZGVsL3tkYXRhc291cmNlfS97YXBwTmFtZX0ve2RhdGFNb2RlbE5hbWV9L3tkYXRhTW9kZWxJZH1cbiAgLyoqXG4gICAqXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxOYW1lIERhdGEgbW9kZWwgbmFtZSB3aGljaCBpcyB0byBiZSBkZWxldGVkXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxJZCBEYXRhIG1vZGVsIGlkIHdoaWNoIGlzIHRvIGJlIGRlbGV0ZWRcbiAgICovXG4gIGRlbGV0ZUJ5SWQoZGF0YU1vZGVsTmFtZSwgZGF0YU1vZGVsSWQpIHtcbiAgICBpZiAoZGF0YU1vZGVsTmFtZSkge1xuICAgICAgaWYgKGRhdGFNb2RlbElkKSB7XG4gICAgICAgIC8vIGNvbnN0IG1vZGVsTmFtZVVybCA9IGAke3RoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKX0ke2RhdGFNb2RlbE5hbWV9LyR7ZGF0YU1vZGVsSWR9YDtcbiAgICAgICAgY29uc3QgbW9kZWxOYW1lVXJsID0gdGhpcy5nZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpICsgZGF0YU1vZGVsTmFtZSArIFwiL1wiICsgZGF0YU1vZGVsSWQ7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlKG1vZGVsTmFtZVVybCkubWFwKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBPYnNlcnZhYmxlLnRocm93KG5ldyBFcnJvcihgQ291bGQgbm90IGdldCAke2RhdGFNb2RlbE5hbWV9IGJ5IGlkICR7ZGF0YU1vZGVsSWR9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbElkfWApKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3cobmV3IEVycm9yKGBDb3VsZCBub3QgZGVsZXRlICR7ZGF0YU1vZGVsTmFtZX0gYnkgaWQgJHtkYXRhTW9kZWxJZH0uICR7dGhpcy5pbnZhbGlkRGF0YU1vZGVsTmFtZX1gKSk7XG4gICAgfVxuICB9XG5cbiAgLy9QQVRDSCAve3RlbmFudE5hbWV9L2RhdGFtb2RlbC97ZGF0YXNvdXJjZX0ve2FwcE5hbWV9L3tkYXRhTW9kZWxOYW1lfS97ZGF0YU1vZGVsSWR9XG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YU1vZGVsTmFtZSBEYXRhIG1vZGVsIG5hbWUgd2hpY2ggaXMgdG8gYmUgdXBkYXRlXG4gICAqIEBwYXJhbSBkYXRhTW9kZWxJZCBEYXRhIG1vZGVsIGlkIHdoaWNoIGlzIHRvIGJlIHVwZGF0ZWRcbiAgICogQHBhcmFtIGRhdGFNb2RlbE9iaiBEYXRhIE1vZGVsIG9iamVjdCB3aGljaCBpcyB0byBiZSBpbnNlcnRlZFxuICAgKi9cbiAgdXBkYXRlQnlJZChkYXRhTW9kZWxOYW1lLCBkYXRhTW9kZWxJZCwgZGF0YU1vZGVsT2JqKSB7XG4gICAgaWYgKGRhdGFNb2RlbE5hbWUpIHtcbiAgICAgIGlmIChkYXRhTW9kZWxJZCkge1xuICAgICAgICAvLyBjb25zdCBtb2RlbE5hbWVVcmwgPSBgJHt0aGlzLmdldERhdGFTb3VyY2VVUkwoZGF0YU1vZGVsTmFtZSl9JHtkYXRhTW9kZWxOYW1lfS8ke2RhdGFNb2RlbElkfWA7XG4gICAgICAgIGNvbnN0IG1vZGVsTmFtZVVybCA9IHRoaXMuZ2V0RGF0YVNvdXJjZVVSTChkYXRhTW9kZWxOYW1lKSArIGRhdGFNb2RlbE5hbWUgKyBcIi9cIiArIGRhdGFNb2RlbElkO1xuICAgICAgICB2YXIgZG1PYmogPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhTW9kZWxPYmopO1xuICAgICAgICBkZWxldGUgZG1PYmpbJ19pZCddO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBhdGNoKG1vZGVsTmFtZVVybCwgZG1PYmopLm1hcCgodmFsdWUsIGluZGV4KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9KS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgT2JzZXJ2YWJsZS50aHJvdyhuZXcgRXJyb3IoYENvdWxkIG5vdCBnZXQgJHtkYXRhTW9kZWxOYW1lfSBieSBpZCAke2RhdGFNb2RlbElkfS4gJHt0aGlzLmludmFsaWREYXRhTW9kZWxJZH1gKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KG5ldyBFcnJvcihgQ291bGQgbm90IGRlbGV0ZSAke2RhdGFNb2RlbE5hbWV9IGJ5IGlkICR7ZGF0YU1vZGVsSWR9LiAke3RoaXMuaW52YWxpZERhdGFNb2RlbE5hbWV9YCkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdG9RdWVyeVN0cmluZyhvYmopIHtcbiAgICBjb25zdCBwYXJ0cyA9IFtdO1xuICAgIGZvciAoY29uc3QgaSBpbiBvYmopIHtcbiAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaSkgJiYgdGhpcy5jaGVja0lmVmFsaWQob2JqW2ldKSkge1xuICAgICAgICBwYXJ0cy5wdXNoKChpKSArICc9JyArIEpTT04uc3RyaW5naWZ5KG9ialtpXSkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcGFydHMuam9pbignJicpO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0lmVmFsaWQodmFsdWU6IGFueSkge1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09IG51bGwpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXRhU291cmNlVVJMKGRhdGFNb2RlbE5hbWUpIHtcbiAgICBpZiAoIXRoaXMuZG1Ecykge1xuICAgICAgdGhpcy5kbURzID0gd2luZG93WyduZXV0cmlub3MnXVsnZGF0YVNvdXJjZSddO1xuICAgIH1cbiAgICBjb25zdCBkc0RtID0gdGhpcy5kbURzW2RhdGFNb2RlbE5hbWVdO1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UucHJvcGVydGllcztcbiAgICBpZiAoZHNEbSkge1xuICAgICAgcmV0dXJuIHByb3BlcnRpZXMuYmFzZVVybCArIHByb3BlcnRpZXMudGVuYW50TmFtZSArICcvZGF0YW1vZGVsLycgKyBkc0RtICsgJy8nICsgcHJvcGVydGllcy5hcHBOYW1lICsgJy8nO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldERhdGFNb2RlbFVybCgpO1xuICAgIH1cbiAgfVxuXG5cbn1cbiJdfQ==