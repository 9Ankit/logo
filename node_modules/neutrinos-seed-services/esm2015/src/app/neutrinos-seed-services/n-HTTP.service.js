/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpHeaders, HttpErrorResponse, HttpClient } from '@angular/common/http';
import { Observable, BehaviorSubject } from 'rxjs/Rx';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
import { NSystemService } from './n-system.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
export class NHttpService {
    /**
     * @param {?} nHTTPLoader
     * @param {?} inj
     * @param {?} nLocalStorageService
     * @param {?} nTokenService
     */
    constructor(nHTTPLoader, inj, nLocalStorageService, nTokenService) {
        this.nHTTPLoader = nHTTPLoader;
        this.inj = inj;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.timeout = 90000;
        this.isRefreshingToken = false;
        this.tokenSubject = new BehaviorSubject(null);
        this.systemService = NSystemService.getInstance();
        this.nSessionStorage = new NSessionStorageService();
        this.appProperties = this.systemService.getVal('properties');
        this.nPubSubService = new NPubSubService();
    }
    /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    intercept(req, next) {
        this.requestInterceptor();
        // Pass on the cloned request instead of the original request.
        return next.handle(this.requestOptions(req))
            .timeout(this.timeout)
            .catch(error => this.onCatch(error, req, next))
            .finally(() => {
            this.onFinally();
        });
    }
    ;
    /**
     * @param {?} error
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    updateToken(error, req, next) {
        if (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
            this.appProperties.appAuthenticationStrategy === 'localAuth') {
            if (!this.isRefreshingToken) {
                this.isRefreshingToken = true;
                // Reset here so that the following requests wait until the token
                // comes back from the refreshToken call.
                this.tokenSubject.next(null);
                return this.refreshToken()
                    .switchMap((tokensObj) => {
                    if (tokensObj) {
                        this.nTokenService.updateTokens(tokensObj);
                        const /** @type {?} */ newToken = tokensObj['accessToken'];
                        this.tokenSubject.next(newToken);
                        return next.handle(this.requestOptions(req));
                    }
                    return Observable.throw(new Error('Can\'t refresh the token'));
                })
                    .catch(err => this.onCatchError(err))
                    .finally(() => this.isRefreshingToken = false);
            }
            else {
                return this.tokenSubject
                    .filter(token => token != null)
                    .take(1)
                    .switchMap(token => next.handle(this.requestOptions(req)));
            }
        }
        else {
            return this.onCatchError(error);
        }
    }
    /**
     * @return {?}
     */
    refreshToken() {
        const /** @type {?} */ http = this.inj.get(HttpClient);
        const /** @type {?} */ appProperties = this.systemService.getVal('properties');
        const /** @type {?} */ refreshUrl = this.systemService.getAuthUrl() + appProperties.appName + '/refresh';
        const /** @type {?} */ body = {
            'platformDetails': this.systemService.getPlatformDetails(this.systemService.checkDevice()),
            'userKey': this.nSessionStorage.getValue('userObj')['userKey'],
            'refreshToken': this.nSessionStorage.getValue('refreshToken')
        };
        body.platformDetails['uuid'] = this.nLocalStorageService.getValue('uuid');
        return http.post(refreshUrl, body);
    }
    /**
     * Request options.
     * @param {?=} req
     * @return {?} HttpRequest
     */
    requestOptions(req) {
        let /** @type {?} */ headers = req.headers;
        if (req.headers == null) {
            headers = new HttpHeaders();
        }
        req = req.clone({
            url: this.getFullUrl(req.url),
            headers: headers
        });
        const /** @type {?} */ baseUrl = NSystemService.getInstance().getVal('baseUrl');
        const /** @type {?} */ isArt = (baseUrl !== '' && req.url.includes(baseUrl));
        return isArt ? this.addDefaultHeaders(req) : req;
    }
    /**
     * Default options.
     * @param {?} req
     * @return {?} HttpHeadedrs
     */
    addDefaultHeaders(req) {
        /**
             * TODO: Add all default Headers over here
             */
        if (!req.headers.has('Access-Control-Allow-Origin')) {
            req.headers = req.headers.set('Access-Control-Allow-Origin', '*');
        }
        if (!req.headers.has('Content-Type')) {
            req.headers = req.headers.set('Content-Type', 'application/json');
        }
        else if (req.headers.has('Content-Type') && (req.headers.get('Content-Type') === 'no-content')) {
            req.headers = req.headers.delete('Content-Type');
        }
        if (!req.headers.has('Accept')) {
            req.headers = req.headers.set('Accept', 'application/json');
        }
        if (!req.headers.has('Authorization')) {
            this.appProperties = this.systemService.getVal('properties');
            if (this.appProperties && this.appProperties.appAuthenticationStrategy === 'basicAuth') {
                let /** @type {?} */ username, /** @type {?} */ password;
                if (this.appProperties.basicAuthUser && this.appProperties.basicAuthPassword) {
                    username = this.appProperties.basicAuthUser;
                    password = this.appProperties.basicAuthPassword;
                }
                else {
                    username = "bhive-art-proxyuser";
                    password = "password";
                    console.warn("Authentication strategy: Basic Auth. basicAuthUser and basicAuthPassword are not configured in environment. Setting default values.");
                }
                req.headers = req.headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
            }
            else if (this.appProperties && (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
                this.appProperties.appAuthenticationStrategy === 'localAuth')) {
                if (this.nSessionStorage.getValue('accessToken')) {
                    req.headers = req.headers.set('Authorization', 'Bearer ' + this.nSessionStorage.getValue('accessToken'));
                }
            }
        }
        return req;
    }
    /**
     * Build API url.
     * @param {?} url
     * @return {?} string
     */
    getFullUrl(url) {
        // return full URL to API here
        return url;
    }
    /**
     * Request interceptor.
     * @return {?}
     */
    requestInterceptor() {
        this.nHTTPLoader.isHTTPRequestInProgress(true);
    }
    /**
     * Response interceptor.
     * @return {?}
     */
    responseInterceptor() {
        this.nHTTPLoader.isHTTPRequestInProgress(false);
    }
    /**
     * Error handler.
     * @param {?} error
     * @param {?} req
     * @param {?} next
     * @return {?} ErrorObservable
     */
    onCatch(error, req, next) {
        if (error instanceof HttpErrorResponse) {
            if ((/** @type {?} */ (error)).status === 403 && (/** @type {?} */ (error)).error.message === 'jwt expired') {
                return this.updateToken(error, req, next);
            }
            else {
                return this.onSubscribeError(error);
            }
        }
        else {
            return this.onSubscribeError(error);
        }
    }
    /**
     * onSubscribeError
     * @param {?} err
     * @return {?}
     */
    onSubscribeError(err) {
        this.nHTTPLoader.alertError(err);
        return this.onCatchError(err);
    }
    /**
     * onFinally
     * @return {?}
     */
    onFinally() {
        this.responseInterceptor();
    }
    /**
     * @param {?} error
     * @return {?}
     */
    onCatchError(error) {
        return Observable.throw(error);
    }
}
NHttpService.decorators = [
    { type: Injectable },
];
/** @nocollapse */
NHttpService.ctorParameters = () => [
    { type: NHTTPLoaderService, },
    { type: Injector, },
    { type: NLocalStorageService, },
    { type: NTokenService, },
];
function NHttpService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NHttpService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NHttpService.ctorParameters;
    /** @type {?} */
    NHttpService.prototype.timeout;
    /** @type {?} */
    NHttpService.prototype.systemService;
    /** @type {?} */
    NHttpService.prototype.nSessionStorage;
    /** @type {?} */
    NHttpService.prototype.appProperties;
    /** @type {?} */
    NHttpService.prototype.isRefreshingToken;
    /** @type {?} */
    NHttpService.prototype.nPubSubService;
    /** @type {?} */
    NHttpService.prototype.tokenSubject;
    /** @type {?} */
    NHttpService.prototype.nHTTPLoader;
    /** @type {?} */
    NHttpService.prototype.inj;
    /** @type {?} */
    NHttpService.prototype.nLocalStorageService;
    /** @type {?} */
    NHttpService.prototype.nTokenService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1IVFRQLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvbi1IVFRQLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFLTCxXQUFXLEVBRVgsaUJBQWlCLEVBQ2pCLFVBQVUsRUFDWCxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR3BELE1BQU07Ozs7Ozs7SUFTSixZQUFvQixXQUErQixFQUFVLEdBQWEsRUFDaEUsc0JBQW9ELGFBQTRCO1FBRHRFLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQVU7UUFDaEUseUJBQW9CLEdBQXBCLG9CQUFvQjtRQUFnQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTt1QkFUaEYsS0FBSztpQ0FJSyxLQUFLOzRCQUVlLElBQUksZUFBZSxDQUFTLElBQUksQ0FBQztRQUl2RSxJQUFJLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNsRCxJQUFJLENBQUMsZUFB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QUFDLENBQUM7YUFDckM7U0FDRjtRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQzs7Ozs7OztJQU9LLGdCQUFnQixDQUFDLEdBQXNCO1FBQzdDLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzs7Ozs7SUFLeEIsU0FBUztRQUNmLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDOzs7Ozs7SUFHckIsWUFBWSxDQUFDLEtBQXdCO1FBQzNDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDOzs7O1lBMU1sQyxVQUFVOzs7O1lBUEYsa0JBQWtCO1lBWk4sUUFBUTtZQWVwQixvQkFBb0I7WUFDcEIsYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIdHRwRXZlbnQsXG4gIEh0dHBJbnRlcmNlcHRvcixcbiAgSHR0cEhhbmRsZXIsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwSGVhZGVycyxcbiAgSHR0cFJlc3BvbnNlLFxuICBIdHRwRXJyb3JSZXNwb25zZSxcbiAgSHR0cENsaWVudFxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzL1J4JztcbmltcG9ydCB7IE5IVFRQTG9hZGVyU2VydmljZSB9IGZyb20gJy4vbi1IVFRQTG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1zZXNzaW9uU3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IE5Ub2tlblNlcnZpY2UgfSBmcm9tICcuL24tdG9rZW4uc2VydmljZSc7XG5pbXBvcnQgeyBOUHViU3ViU2VydmljZSB9IGZyb20gJy4vbi1wdWJTdWIuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOSHR0cFNlcnZpY2Uge1xuICB0aW1lb3V0ID0gOTAwMDA7XG4gIHN5c3RlbVNlcnZpY2U7XG4gIG5TZXNzaW9uU3RvcmFnZTtcbiAgYXBwUHJvcGVydGllcztcbiAgaXNSZWZyZXNoaW5nVG9rZW4gPSBmYWxzZTtcbiAgblB1YlN1YlNlcnZpY2U7XG4gIHRva2VuU3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4obnVsbCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuSFRUUExvYWRlcjogTkhUVFBMb2FkZXJTZXJ2aWNlLCBwcml2YXRlIGluajogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBuTG9jYWxTdG9yYWdlU2VydmljZTogTkxvY2FsU3RvcmFnZVNlcnZpY2UsIHByaXZhdGUgblRva2VuU2VydmljZTogTlRva2VuU2VydmljZSkge1xuICAgIHRoaXMuc3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5uU2Vzc2lvblN0b3JhZ2UgPSBuZXcgTlNlc3Npb25TdG9yYWdlU2VydmljZSgpO1xuICAgIHRoaXMuYXBwUHJvcGVydGllcyA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3Byb3BlcnRpZXMnKTtcbiAgICB0aGlzLm5QdWJTdWJTZXJ2aWNlID0gbmV3IE5QdWJTdWJTZXJ2aWNlKCk7XG4gIH1cblxuICBpbnRlcmNlcHQocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICB0aGlzLnJlcXVlc3RJbnRlcmNlcHRvcigpO1xuXG4gICAgLy8gUGFzcyBvbiB0aGUgY2xvbmVkIHJlcXVlc3QgaW5zdGVhZCBvZiB0aGUgb3JpZ2luYWwgcmVxdWVzdC5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKVxuICAgICAgLnRpbWVvdXQodGhpcy50aW1lb3V0KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHRoaXMub25DYXRjaChlcnJvciwgcmVxLCBuZXh0KSlcbiAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgdGhpcy5vbkZpbmFsbHkoKTtcbiAgICAgIH0pO1xuICB9O1xuXG4gIHVwZGF0ZVRva2VuKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSwgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IGFueSB7XG4gICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYWN0aXZlRGlyZWN0b3J5JyB8fFxuICAgICAgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcEF1dGhlbnRpY2F0aW9uU3RyYXRlZ3kgPT09ICdsb2NhbEF1dGgnKSB7XG4gICAgICBpZiAoIXRoaXMuaXNSZWZyZXNoaW5nVG9rZW4pIHtcbiAgICAgICAgdGhpcy5pc1JlZnJlc2hpbmdUb2tlbiA9IHRydWU7XG5cbiAgICAgICAgLy8gUmVzZXQgaGVyZSBzbyB0aGF0IHRoZSBmb2xsb3dpbmcgcmVxdWVzdHMgd2FpdCB1bnRpbCB0aGUgdG9rZW5cbiAgICAgICAgLy8gY29tZXMgYmFjayBmcm9tIHRoZSByZWZyZXNoVG9rZW4gY2FsbC5cbiAgICAgICAgdGhpcy50b2tlblN1YmplY3QubmV4dChudWxsKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5yZWZyZXNoVG9rZW4oKVxuICAgICAgICAgIC5zd2l0Y2hNYXAoKHRva2Vuc09iajogT2JqZWN0KSA9PiB7XG4gICAgICAgICAgICBpZiAodG9rZW5zT2JqKSB7XG4gICAgICAgICAgICAgIHRoaXMublRva2VuU2VydmljZS51cGRhdGVUb2tlbnModG9rZW5zT2JqKTtcbiAgICAgICAgICAgICAgY29uc3QgbmV3VG9rZW4gPSB0b2tlbnNPYmpbJ2FjY2Vzc1Rva2VuJ107XG4gICAgICAgICAgICAgIHRoaXMudG9rZW5TdWJqZWN0Lm5leHQobmV3VG9rZW4pO1xuICAgICAgICAgICAgICByZXR1cm4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KG5ldyBFcnJvcignQ2FuXFwndCByZWZyZXNoIHRoZSB0b2tlbicpKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC5jYXRjaChlcnIgPT4gdGhpcy5vbkNhdGNoRXJyb3IoZXJyKSlcbiAgICAgICAgICAuZmluYWxseSgoKSA9PiB0aGlzLmlzUmVmcmVzaGluZ1Rva2VuID0gZmFsc2UpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy50b2tlblN1YmplY3RcbiAgICAgICAgICAuZmlsdGVyKHRva2VuID0+IHRva2VuICE9IG51bGwpXG4gICAgICAgICAgLnRha2UoMSlcbiAgICAgICAgICAuc3dpdGNoTWFwKHRva2VuID0+IG5leHQuaGFuZGxlKHRoaXMucmVxdWVzdE9wdGlvbnMocmVxKSkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5vbkNhdGNoRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHJlZnJlc2hUb2tlbigpIHtcbiAgICBjb25zdCBodHRwID0gdGhpcy5pbmouZ2V0KEh0dHBDbGllbnQpO1xuICAgIGNvbnN0IGFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XG4gICAgY29uc3QgcmVmcmVzaFVybCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRBdXRoVXJsKCkgKyBhcHBQcm9wZXJ0aWVzLmFwcE5hbWUgKyAnL3JlZnJlc2gnO1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICAncGxhdGZvcm1EZXRhaWxzJzogdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFBsYXRmb3JtRGV0YWlscyh0aGlzLnN5c3RlbVNlcnZpY2UuY2hlY2tEZXZpY2UoKSksXG4gICAgICAndXNlcktleSc6IHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCd1c2VyT2JqJylbJ3VzZXJLZXknXSxcbiAgICAgICdyZWZyZXNoVG9rZW4nOiB0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgncmVmcmVzaFRva2VuJylcbiAgICB9O1xuICAgIGJvZHkucGxhdGZvcm1EZXRhaWxzWyd1dWlkJ10gPSB0aGlzLm5Mb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlKCd1dWlkJyk7XG4gICAgcmV0dXJuIGh0dHAucG9zdChyZWZyZXNoVXJsLCBib2R5KTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIFJlcXVlc3Qgb3B0aW9ucy5cbiAgICogQHBhcmFtIG9wdGlvbnNcbiAgICogQHJldHVybnMgSHR0cFJlcXVlc3RcbiAgICovXG4gIHByaXZhdGUgcmVxdWVzdE9wdGlvbnMocmVxPzogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGxldCBoZWFkZXJzID0gcmVxLmhlYWRlcnM7XG4gICAgaWYgKHJlcS5oZWFkZXJzID09IG51bGwpIHtcbiAgICAgIGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoKTtcbiAgICB9XG4gICAgcmVxID0gcmVxLmNsb25lKHtcbiAgICAgIHVybDogdGhpcy5nZXRGdWxsVXJsKHJlcS51cmwpLFxuICAgICAgaGVhZGVyczogaGVhZGVyc1xuICAgIH0pO1xuICAgIGNvbnN0IGJhc2VVcmwgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpLmdldFZhbCgnYmFzZVVybCcpO1xuICAgIGNvbnN0IGlzQXJ0ID0gKGJhc2VVcmwgIT09ICcnICYmIHJlcS51cmwuaW5jbHVkZXMoYmFzZVVybCkpO1xuICAgIHJldHVybiAgaXNBcnQgPyB0aGlzLmFkZERlZmF1bHRIZWFkZXJzKHJlcSkgOiByZXE7XG4gIH1cblxuXG4gIC8qKlxuICAqIERlZmF1bHQgb3B0aW9ucy5cbiAgKiBAcGFyYW0gb3B0aW9uc1xuICAqIEByZXR1cm5zIEh0dHBIZWFkZWRyc1xuICAqL1xuICBwcml2YXRlIGFkZERlZmF1bHRIZWFkZXJzKHJlcTogYW55KSB7XG4gICAgLyoqXG4gICAgICogVE9ETzogQWRkIGFsbCBkZWZhdWx0IEhlYWRlcnMgb3ZlciBoZXJlXG4gICAgICovXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbicpKSB7XG4gICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQ29udGVudC1UeXBlJykpIHtcbiAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIH0gZWxzZSBpZiAocmVxLmhlYWRlcnMuaGFzKCdDb250ZW50LVR5cGUnKSAmJiAocmVxLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKSA9PT0gJ25vLWNvbnRlbnQnKSkge1xuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5kZWxldGUoJ0NvbnRlbnQtVHlwZScpO1xuICAgIH1cblxuICAgIGlmICghcmVxLmhlYWRlcnMuaGFzKCdBY2NlcHQnKSkge1xuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0FjY2VwdCcsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0F1dGhvcml6YXRpb24nKSkge1xuICAgICAgdGhpcy5hcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xuICAgICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcyAmJiB0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2Jhc2ljQXV0aCcpIHtcbiAgICAgICAgbGV0IHVzZXJuYW1lLCBwYXNzd29yZDtcbiAgICAgICAgaWYgKHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhVc2VyICYmIHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhQYXNzd29yZCkge1xuICAgICAgICAgIHVzZXJuYW1lID0gdGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFVzZXI7XG4gICAgICAgICAgcGFzc3dvcmQgPSB0aGlzLmFwcFByb3BlcnRpZXMuYmFzaWNBdXRoUGFzc3dvcmQ7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdXNlcm5hbWUgPSBcImJoaXZlLWFydC1wcm94eXVzZXJcIjtcbiAgICAgICAgICBwYXNzd29yZCA9IFwicGFzc3dvcmRcIjtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXCJBdXRoZW50aWNhdGlvbiBzdHJhdGVneTogQmFzaWMgQXV0aC4gYmFzaWNBdXRoVXNlciBhbmQgYmFzaWNBdXRoUGFzc3dvcmQgYXJlIG5vdCBjb25maWd1cmVkIGluIGVudmlyb25tZW50LiBTZXR0aW5nIGRlZmF1bHQgdmFsdWVzLlwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsICdCYXNpYyAnICsgYnRvYSh1c2VybmFtZSArIFwiOlwiICsgcGFzc3dvcmQpKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzICYmICh0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2FjdGl2ZURpcmVjdG9yeScgfHxcbiAgICAgICAgdGhpcy5hcHBQcm9wZXJ0aWVzLmFwcEF1dGhlbnRpY2F0aW9uU3RyYXRlZ3kgPT09ICdsb2NhbEF1dGgnKSkge1xuICAgICAgICBpZiAodGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykpIHtcbiAgICAgICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsICdCZWFyZXIgJyArIHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdhY2Nlc3NUb2tlbicpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVxO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIEFQSSB1cmwuXG4gICAqIEBwYXJhbSB1cmxcbiAgICogQHJldHVybnMgc3RyaW5nXG4gICAqL1xuICBwcml2YXRlIGdldEZ1bGxVcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIHJldHVybiBmdWxsIFVSTCB0byBBUEkgaGVyZVxuICAgIHJldHVybiB1cmw7XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdCBpbnRlcmNlcHRvci5cbiAgICovXG4gIHByaXZhdGUgcmVxdWVzdEludGVyY2VwdG9yKCk6IHZvaWQge1xuICAgIHRoaXMubkhUVFBMb2FkZXIuaXNIVFRQUmVxdWVzdEluUHJvZ3Jlc3ModHJ1ZSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzcG9uc2UgaW50ZXJjZXB0b3IuXG4gICAqL1xuICBwcml2YXRlIHJlc3BvbnNlSW50ZXJjZXB0b3IoKTogdm9pZCB7XG4gICAgdGhpcy5uSFRUUExvYWRlci5pc0hUVFBSZXF1ZXN0SW5Qcm9ncmVzcyhmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICAqIEVycm9yIGhhbmRsZXIuXG4gICAgKiBAcGFyYW0gZXJyb3JcbiAgICAqIEBwYXJhbSBjYXVnaHRcbiAgICAqIEByZXR1cm5zIEVycm9yT2JzZXJ2YWJsZVxuICAgICovXG4gIHByaXZhdGUgb25DYXRjaChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UsIHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgICBpZiAoKDxIdHRwRXJyb3JSZXNwb25zZT5lcnJvcikuc3RhdHVzID09PSA0MDMgJiYgKDxIdHRwRXJyb3JSZXNwb25zZT5lcnJvcikuZXJyb3IubWVzc2FnZSA9PT0gJ2p3dCBleHBpcmVkJykge1xuICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVUb2tlbihlcnJvciwgcmVxLCBuZXh0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uU3Vic2NyaWJlRXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5vblN1YnNjcmliZUVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogb25TdWJzY3JpYmVFcnJvclxuICAgKiBAcGFyYW0gZXJyb3JcbiAgICovXG4gIHByaXZhdGUgb25TdWJzY3JpYmVFcnJvcihlcnI6IEh0dHBFcnJvclJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICB0aGlzLm5IVFRQTG9hZGVyLmFsZXJ0RXJyb3IoZXJyKTtcbiAgICByZXR1cm4gdGhpcy5vbkNhdGNoRXJyb3IoZXJyKTtcbiAgfVxuICAvKipcbiAgICogb25GaW5hbGx5XG4gICAqL1xuICBwcml2YXRlIG9uRmluYWxseSgpOiB2b2lkIHtcbiAgICB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3IoKTtcbiAgfVxuXG4gIHByaXZhdGUgb25DYXRjaEVycm9yKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coZXJyb3IpO1xuICB9XG5cbn1cbiJdfQ==