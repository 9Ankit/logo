/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { NLocalStorageService } from './n-localStorage.service';
import * as firebase from 'firebase';
import { NPubSubService } from './n-pubSub.service';
import { HttpClient } from '@angular/common/http';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
export class NNotificationService {
    /**
     * @param {?} localStorageService
     * @param {?} pubSubService
     * @param {?} http
     * @param {?} bHttpLoader
     */
    constructor(localStorageService, pubSubService, http, bHttpLoader) {
        this.localStorageService = localStorageService;
        this.pubSubService = pubSubService;
        this.http = http;
        this.bHttpLoader = bHttpLoader;
        this.systemService = NSystemService.getInstance();
        this.possiblePushTypes = ['APNS', 'FCM'];
        this.firebaseSenderId = this.systemService.getVal('firebaseSenderId');
        this.isNotificationEnabled = this.systemService.getVal('isNotificationEnabled');
        this.appName = this.systemService.getVal('appName');
        this.deviceType = this.systemService.deviceType;
        this.sessionStorage = new NSessionStorageService();
        this.loginSubscribe = this.pubSubService.$sub('firebaseRegister', () => {
            this.enableNotification();
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @return {?}
     */
    enableNotification() {
        let /** @type {?} */ pushType = this.getPushType(this.systemService.getVal('pushType'));
        document.addEventListener('deviceready', event => {
            if (this.isNotificationEnabled) {
                if (this.deviceType && this.deviceType != 'browser') {
                    this.deviceType = this.systemService.deviceType;
                    this.checkPermission(pushType).then(res => {
                        if (res) {
                            this.initializeNotifications(pushType);
                        }
                    });
                }
            }
        });
        if (this.isNotificationEnabled && pushType !== 'APNS') {
            if (this.deviceType && this.deviceType == 'browser' && window['Notification']) {
                this.initialiseWebPush();
            }
        }
    }
    /**
     * @return {?}
     */
    initialiseWebPush() {
        const /** @type {?} */ __this = this;
        const /** @type {?} */ messaging = firebase.messaging();
        messaging.requestPermission()
            .then(function () {
            return messaging.getToken();
        })
            .then(function (token) {
            if (token) {
                __this.sendRegDetails(token);
            }
        })
            .catch(function (err) {
            __this.bHttpLoader.alertError(err);
        });
        messaging.onMessage(function (payload) {
            if (payload['notification']) {
                let /** @type {?} */ notificationObj = payload['notification'];
                let /** @type {?} */ options = {
                    body: notificationObj.body,
                    icon: notificationObj.icon
                };
                // creating a native browser message
                let /** @type {?} */ notificationUI = new Notification(notificationObj.title, options);
                notificationUI.onclick = function () {
                    window.focus(); // window is focused when the user clicks the notification using this
                };
            }
        });
    }
    /**
     * @param {?=} pushType
     * @return {?}
     */
    checkPermission(pushType) {
        // Android & iOS only
        // Checks whether the push notification permission has been granted.
        return new Promise((resolve) => {
            pushType = this.getPushType(pushType);
            if ((this.deviceType === 'Android' || this.deviceType === 'iOS') && (pushType === 'FCM')) {
                PushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else if (this.deviceType === 'iOS' && pushType === 'APNS') {
                APNSPushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else {
                return resolve(true);
            }
        });
    }
    /**
     * @param {?=} pushType
     * @return {?}
     */
    initializeNotifications(pushType) {
        //pushType = pushType ? pushType : 'FCM';
        pushType = this.getPushType(pushType);
        let /** @type {?} */ push;
        // Default if for FCM
        if (pushType === 'FCM') {
            push = window['PushNotification'].init({
                android: {
                    senderID: this.firebaseSenderId
                },
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true",
                    senderID: this.firebaseSenderId
                },
            });
        }
        else if (pushType === 'APNS') {
            push = window['APNSPushNotification'].init({
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true"
                }
            });
        }
        push.on('registration', (data) => {
            // data.registrationId
            this.sendRegDetails(data.registrationId);
        });
        // ToDo Christy get call back function from app user to change what happens once a notification arrives
        push.on('notification', (data) => {
            window['cordova'].plugins.notification.local.schedule({
                title: data.title,
                text: data.message,
                sound: data.sound,
                at: new Date().getTime()
            });
        });
        push.on('error', (e) => {
            // e.message
            console.error(e);
        });
    }
    /**
     * @param {?} registrationId
     * @return {?}
     */
    sendRegDetails(registrationId) {
        this.localStorageService.setValue('registrationId', registrationId);
        var /** @type {?} */ url = this.systemService.getTenantUrl() + 'notification/' + this.systemService.getVal('appName') + '/register';
        let /** @type {?} */ pushType = this.getPushType(this.systemService.getVal('pushType'));
        this.http.post(url, {
            'key': this.sessionStorage.getValue('userObj')['userKey'],
            'uuid': this.localStorageService.getValue('uuid'),
            'fbregid': registrationId,
            'pushType': pushType
        }).subscribe(result => {
            // this.pubSubService.$pub('FBRegComp');
        }, error => {
            console.log(error);
        });
    }
    /**
     * @param {?} currPushType
     * @return {?}
     */
    getPushType(currPushType) {
        let /** @type {?} */ isValidPush = typeof currPushType !== 'undefined' && this.possiblePushTypes.includes(currPushType.toUpperCase());
        let /** @type {?} */ pushType = isValidPush ? currPushType.toUpperCase() : 'FCM';
        return pushType;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.loginSubscribe.unSubscribe();
    }
}
NNotificationService.decorators = [
    { type: Injectable },
];
/** @nocollapse */
NNotificationService.ctorParameters = () => [
    { type: NLocalStorageService, },
    { type: NPubSubService, },
    { type: HttpClient, },
    { type: NHTTPLoaderService, },
];
function NNotificationService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NNotificationService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NNotificationService.ctorParameters;
    /** @type {?} */
    NNotificationService.prototype.systemService;
    /** @type {?} */
    NNotificationService.prototype.firebaseSenderId;
    /** @type {?} */
    NNotificationService.prototype.isNotificationEnabled;
    /** @type {?} */
    NNotificationService.prototype.deviceType;
    /** @type {?} */
    NNotificationService.prototype.string;
    /** @type {?} */
    NNotificationService.prototype.resDetails;
    /** @type {?} */
    NNotificationService.prototype.deviceUUID;
    /** @type {?} */
    NNotificationService.prototype.possiblePushTypes;
    /** @type {?} */
    NNotificationService.prototype.loginSubscribe;
    /** @type {?} */
    NNotificationService.prototype.sessionStorage;
    /** @type {?} */
    NNotificationService.prototype.appName;
    /** @type {?} */
    NNotificationService.prototype.localStorageService;
    /** @type {?} */
    NNotificationService.prototype.pubSubService;
    /** @type {?} */
    NNotificationService.prototype.http;
    /** @type {?} */
    NNotificationService.prototype.bHttpLoader;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1ub3RpZmljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLW5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJcEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxLQUFLLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUs1RCxNQUFNOzs7Ozs7O0lBWUosWUFBb0IsbUJBQXlDLEVBQVUsYUFBNkIsRUFDMUYsTUFBMEIsV0FBK0I7UUFEL0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFzQjtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFnQjtRQUMxRixTQUFJLEdBQUosSUFBSTtRQUFzQixnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7NkJBWDNCLGNBQWMsQ0FBQyxXQUFXLEVBQUU7aUNBTTlCLENBQUMsTUFBTSxFQUFDLEtBQUssQ0FBQztRQU1sRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsdUJB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QUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ3JILHFCQUFJLFFBQVEsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxRQUFRLENBQUM7S0FDakI7Ozs7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztLQUNuQzs7O1lBakxGLFVBQVU7Ozs7WUFWRixvQkFBb0I7WUFFcEIsY0FBYztZQUNkLFVBQVU7WUFHVixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkluaXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5kZWNsYXJlIHZhciBQdXNoTm90aWZpY2F0aW9uOiBhbnk7XG5kZWNsYXJlIHZhciBBUE5TUHVzaE5vdGlmaWNhdGlvbjogYW55O1xuaW1wb3J0IHsgTkxvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tbG9jYWxTdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0ICogYXMgZmlyZWJhc2UgZnJvbSAnZmlyZWJhc2UnO1xuaW1wb3J0IHsgTlB1YlN1YlNlcnZpY2UgfSBmcm9tICcuL24tcHViU3ViLnNlcnZpY2UnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tc2Vzc2lvblN0b3JhZ2Uuc2VydmljZSc7XG4vLyBpbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgTkhUVFBMb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi9uLUhUVFBMb2FkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBlbnZpcm9ubWVudCB9IGZyb20gJy4uLy4uL2Vudmlyb25tZW50cy9lbnZpcm9ubWVudC5wcm9kJztcblxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTk5vdGlmaWNhdGlvblNlcnZpY2Uge1xuICAvLyBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogTk5vdGlmaWNhdGlvblNlcnZpY2U7XG4gIHByaXZhdGUgc3lzdGVtU2VydmljZTogTlN5c3RlbVNlcnZpY2UgPSBOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICBwcml2YXRlIGZpcmViYXNlU2VuZGVySWQ6IHN0cmluZztcbiAgcHJpdmF0ZSBpc05vdGlmaWNhdGlvbkVuYWJsZWQ6IGJvb2xlYW47XG4gIHByaXZhdGUgZGV2aWNlVHlwZTsgc3RyaW5nO1xuICBwcml2YXRlIHJlc0RldGFpbHM7XG4gIHByaXZhdGUgZGV2aWNlVVVJRDogc3RyaW5nO1xuICBwcml2YXRlIHBvc3NpYmxlUHVzaFR5cGVzOiBzdHJpbmdbXSA9IFsnQVBOUycsJ0ZDTSddO1xuICBsb2dpblN1YnNjcmliZTtcbiAgc2Vzc2lvblN0b3JhZ2U6IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2U7XG4gIGFwcE5hbWU7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbG9jYWxTdG9yYWdlU2VydmljZTogTkxvY2FsU3RvcmFnZVNlcnZpY2UsIHByaXZhdGUgcHViU3ViU2VydmljZTogTlB1YlN1YlNlcnZpY2UsXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBwcml2YXRlIGJIdHRwTG9hZGVyOiBOSFRUUExvYWRlclNlcnZpY2UpIHtcbiAgICB0aGlzLmZpcmViYXNlU2VuZGVySWQgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdmaXJlYmFzZVNlbmRlcklkJyk7XG4gICAgdGhpcy5pc05vdGlmaWNhdGlvbkVuYWJsZWQgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdpc05vdGlmaWNhdGlvbkVuYWJsZWQnKTtcbiAgICB0aGlzLmFwcE5hbWUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdhcHBOYW1lJyk7XG4gICAgdGhpcy5kZXZpY2VUeXBlID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmRldmljZVR5cGU7XG4gICAgdGhpcy5zZXNzaW9uU3RvcmFnZSA9IG5ldyBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlKCk7XG4gICAgdGhpcy5sb2dpblN1YnNjcmliZSA9IHRoaXMucHViU3ViU2VydmljZS4kc3ViKCdmaXJlYmFzZVJlZ2lzdGVyJywgKCkgPT4ge1xuICAgICAgdGhpcy5lbmFibGVOb3RpZmljYXRpb24oKTtcbiAgICB9KVxuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gIH1cblxuXG4gIGVuYWJsZU5vdGlmaWNhdGlvbigpIHtcbiAgICBsZXQgcHVzaFR5cGUgPSB0aGlzLmdldFB1c2hUeXBlKHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3B1c2hUeXBlJykpO1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZXJlYWR5JywgZXZlbnQgPT4ge1xuICAgICAgaWYgKHRoaXMuaXNOb3RpZmljYXRpb25FbmFibGVkKSB7XG4gICAgICAgIGlmICh0aGlzLmRldmljZVR5cGUgJiYgdGhpcy5kZXZpY2VUeXBlICE9ICdicm93c2VyJykge1xuICAgICAgICAgIHRoaXMuZGV2aWNlVHlwZSA9IHRoaXMuc3lzdGVtU2VydmljZS5kZXZpY2VUeXBlO1xuICAgICAgICAgIHRoaXMuY2hlY2tQZXJtaXNzaW9uKHB1c2hUeXBlKS50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZU5vdGlmaWNhdGlvbnMocHVzaFR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKHRoaXMuaXNOb3RpZmljYXRpb25FbmFibGVkICYmIHB1c2hUeXBlICE9PSAnQVBOUycpIHtcbiAgICAgIGlmICh0aGlzLmRldmljZVR5cGUgJiYgdGhpcy5kZXZpY2VUeXBlID09ICdicm93c2VyJyAmJiB3aW5kb3dbJ05vdGlmaWNhdGlvbiddKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGlzZVdlYlB1c2goKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpbml0aWFsaXNlV2ViUHVzaCgpIHtcbiAgICBjb25zdCBfX3RoaXMgPSB0aGlzO1xuICAgIGNvbnN0IG1lc3NhZ2luZyA9IGZpcmViYXNlLm1lc3NhZ2luZygpO1xuXG4gICAgbWVzc2FnaW5nLnJlcXVlc3RQZXJtaXNzaW9uKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIG1lc3NhZ2luZy5nZXRUb2tlbigpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGZ1bmN0aW9uICh0b2tlbikge1xuICAgICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgICBfX3RoaXMuc2VuZFJlZ0RldGFpbHModG9rZW4pO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgX190aGlzLmJIdHRwTG9hZGVyLmFsZXJ0RXJyb3IoZXJyKTtcbiAgICAgIH0pO1xuXG4gICAgbWVzc2FnaW5nLm9uTWVzc2FnZShmdW5jdGlvbiAocGF5bG9hZCkge1xuICAgICAgaWYgKHBheWxvYWRbJ25vdGlmaWNhdGlvbiddKSB7XG4gICAgICAgIGxldCBub3RpZmljYXRpb25PYmogPSBwYXlsb2FkWydub3RpZmljYXRpb24nXTtcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgYm9keTogbm90aWZpY2F0aW9uT2JqLmJvZHksXG4gICAgICAgICAgaWNvbjogbm90aWZpY2F0aW9uT2JqLmljb25cbiAgICAgICAgfVxuICAgICAgICAvLyBjcmVhdGluZyBhIG5hdGl2ZSBicm93c2VyIG1lc3NhZ2VcbiAgICAgICAgbGV0IG5vdGlmaWNhdGlvblVJID0gbmV3IE5vdGlmaWNhdGlvbihub3RpZmljYXRpb25PYmoudGl0bGUsIG9wdGlvbnMpO1xuICAgICAgICBub3RpZmljYXRpb25VSS5vbmNsaWNrID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIHdpbmRvdy5mb2N1cygpOyAvLyB3aW5kb3cgaXMgZm9jdXNlZCB3aGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgbm90aWZpY2F0aW9uIHVzaW5nIHRoaXNcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgY2hlY2tQZXJtaXNzaW9uKHB1c2hUeXBlPykge1xuICAgIC8vIEFuZHJvaWQgJiBpT1Mgb25seVxuICAgIC8vIENoZWNrcyB3aGV0aGVyIHRoZSBwdXNoIG5vdGlmaWNhdGlvbiBwZXJtaXNzaW9uIGhhcyBiZWVuIGdyYW50ZWQuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUocHVzaFR5cGUpO1xuICAgICAgaWYgKCh0aGlzLmRldmljZVR5cGUgPT09ICdBbmRyb2lkJyB8fCB0aGlzLmRldmljZVR5cGUgPT09ICdpT1MnKSAmJiAocHVzaFR5cGUgPT09ICdGQ00nICkpIHtcbiAgICAgICAgUHVzaE5vdGlmaWNhdGlvbi5oYXNQZXJtaXNzaW9uKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoZGF0YS5pc0VuYWJsZWQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5kZXZpY2VUeXBlID09PSAnaU9TJyAmJiBwdXNoVHlwZSA9PT0gJ0FQTlMnKSB7XG4gICAgICAgICBBUE5TUHVzaE5vdGlmaWNhdGlvbi5oYXNQZXJtaXNzaW9uKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUoZGF0YS5pc0VuYWJsZWQpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXNvbHZlKHRydWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaW5pdGlhbGl6ZU5vdGlmaWNhdGlvbnMocHVzaFR5cGU/KSB7XG4gICAgLy9wdXNoVHlwZSA9IHB1c2hUeXBlID8gcHVzaFR5cGUgOiAnRkNNJztcbiAgICBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUocHVzaFR5cGUpO1xuXG4gICAgbGV0IHB1c2g7XG4gICAgLy8gRGVmYXVsdCBpZiBmb3IgRkNNXG4gICAgaWYgKHB1c2hUeXBlID09PSAnRkNNJykge1xuICAgICAgcHVzaCA9IHdpbmRvd1snUHVzaE5vdGlmaWNhdGlvbiddLmluaXQoe1xuICAgICAgICBhbmRyb2lkOiB7XG4gICAgICAgICAgc2VuZGVySUQ6IHRoaXMuZmlyZWJhc2VTZW5kZXJJZFxuICAgICAgICB9LFxuICAgICAgICBpb3M6IHtcbiAgICAgICAgICBhbGVydDogXCJ0cnVlXCIsXG4gICAgICAgICAgYmFkZ2U6IFwidHJ1ZVwiLFxuICAgICAgICAgIHNvdW5kOiBcInRydWVcIixcbiAgICAgICAgICBzZW5kZXJJRDogdGhpcy5maXJlYmFzZVNlbmRlcklkXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gICAgLy8gTmV3IEFQTlMgcGx1Z2luIGluaXRcbiAgICBlbHNlIGlmIChwdXNoVHlwZSA9PT0gJ0FQTlMnKSB7XG4gICAgICBwdXNoID0gd2luZG93WydBUE5TUHVzaE5vdGlmaWNhdGlvbiddLmluaXQoe1xuICAgICAgICBpb3M6IHtcbiAgICAgICAgICBhbGVydDogXCJ0cnVlXCIsXG4gICAgICAgICAgYmFkZ2U6IFwidHJ1ZVwiLFxuICAgICAgICAgIHNvdW5kOiBcInRydWVcIlxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcHVzaC5vbigncmVnaXN0cmF0aW9uJywgKGRhdGEpID0+IHtcbiAgICAgIC8vIGRhdGEucmVnaXN0cmF0aW9uSWRcbiAgICAgIHRoaXMuc2VuZFJlZ0RldGFpbHMoZGF0YS5yZWdpc3RyYXRpb25JZCk7XG4gICAgfSk7XG5cbiAgICAvLyBUb0RvIENocmlzdHkgZ2V0IGNhbGwgYmFjayBmdW5jdGlvbiBmcm9tIGFwcCB1c2VyIHRvIGNoYW5nZSB3aGF0IGhhcHBlbnMgb25jZSBhIG5vdGlmaWNhdGlvbiBhcnJpdmVzXG4gICAgcHVzaC5vbignbm90aWZpY2F0aW9uJywgKGRhdGEpID0+IHtcbiAgICAgIHdpbmRvd1snY29yZG92YSddLnBsdWdpbnMubm90aWZpY2F0aW9uLmxvY2FsLnNjaGVkdWxlKHtcbiAgICAgICAgdGl0bGU6IGRhdGEudGl0bGUsXG4gICAgICAgIHRleHQ6IGRhdGEubWVzc2FnZSxcbiAgICAgICAgc291bmQ6IGRhdGEuc291bmQsXG4gICAgICAgIGF0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBwdXNoLm9uKCdlcnJvcicsIChlKSA9PiB7XG4gICAgICAvLyBlLm1lc3NhZ2VcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgfSk7XG4gIH1cblxuICBzZW5kUmVnRGV0YWlscyhyZWdpc3RyYXRpb25JZCkge1xuICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5zZXRWYWx1ZSgncmVnaXN0cmF0aW9uSWQnLCByZWdpc3RyYXRpb25JZCk7XG4gICAgdmFyIHVybCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRUZW5hbnRVcmwoKSArICdub3RpZmljYXRpb24vJyArIHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2FwcE5hbWUnKSArICcvcmVnaXN0ZXInO1xuICAgIGxldCBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHVzaFR5cGUnKSk7XG4gICAgdGhpcy5odHRwLnBvc3QodXJsLCB7XG4gICAgICAna2V5JzogdGhpcy5zZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgndXNlck9iaicpWyd1c2VyS2V5J10sXG4gICAgICAndXVpZCc6IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXRWYWx1ZSgndXVpZCcpLCBcbiAgICAgICdmYnJlZ2lkJzogcmVnaXN0cmF0aW9uSWQsXG4gICAgICAncHVzaFR5cGUnOiBwdXNoVHlwZVxuICAgIH0pLnN1YnNjcmliZShyZXN1bHQgPT4ge1xuICAgICAgLy8gdGhpcy5wdWJTdWJTZXJ2aWNlLiRwdWIoJ0ZCUmVnQ29tcCcpO1xuICAgIH0sIGVycm9yID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICB9KVxuICB9XG5cbiAgZ2V0UHVzaFR5cGUgKGN1cnJQdXNoVHlwZSkge1xuICAgIGxldCBpc1ZhbGlkUHVzaCA9IHR5cGVvZiBjdXJyUHVzaFR5cGUgIT09ICd1bmRlZmluZWQnICYmIHRoaXMucG9zc2libGVQdXNoVHlwZXMuaW5jbHVkZXMoY3VyclB1c2hUeXBlLnRvVXBwZXJDYXNlKCkpO1xuICAgIGxldCBwdXNoVHlwZSA9IGlzVmFsaWRQdXNoID8gY3VyclB1c2hUeXBlLnRvVXBwZXJDYXNlKCkgOiAnRkNNJztcbiAgICByZXR1cm4gcHVzaFR5cGU7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmxvZ2luU3Vic2NyaWJlLnVuU3Vic2NyaWJlKCk7XG4gIH1cbiAgXG59XG4iXX0=