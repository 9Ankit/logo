/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { NSystemService } from './n-system.service';
import { Injectable } from '@angular/core';
import { NgForage, NgForageCache, NgForageConfig } from 'ngforage';
import { NUtility } from './n-util.service';
var NLocalStorageService = /** @class */ (function () {
    function NLocalStorageService(ngfConfig, ngf, ngfCache) {
        this.ngfConfig = ngfConfig;
        this.ngf = ngf;
        this.ngfCache = ngfCache;
        this.storageCache = {};
    }
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.initStorage = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova']) {
                _this.initNgForage();
            }
            _this.ngf.iterate(function (value, key, iteratonNumber) {
                _this.storageCache[key] = value;
            }).then(function (result) {
                _this.checkDeviceId();
                return resolve('iteration is completed');
            }).catch(function (error) {
                return reject(error);
            });
        });
    };
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.getStorage = /**
     * @return {?}
     */
    function () {
        return this.storageCache;
    };
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    NLocalStorageService.prototype.setValue = /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    function (key, value) {
        if (window['cordova']) {
            this.initNgForage();
        }
        this.storageCache[key] = value;
        return this.ngf.setItem(key, value).then(function (result) {
            return result;
        }, function (error) {
            console.log(error);
        });
    };
    /**
     * @param {?} key
     * @return {?}
     */
    NLocalStorageService.prototype.getValue = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        if (!this.storageCache[key]) {
            return null;
        }
        try {
            var /** @type {?} */ obj = this.storageCache[key];
            return JSON.parse(obj);
        }
        catch (/** @type {?} */ error) {
            return this.storageCache[key];
        }
    };
    /**
     * @param {?} key
     * @return {?}
     */
    NLocalStorageService.prototype.remove = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        delete this.storageCache[key];
        if (window['cordova']) {
            this.initNgForage();
        }
        this.ngf.removeItem(key).then(function (fulfilled) {
            delete _this.ngf[key];
        }).catch(function (error) {
            console.error('Could not remove', key);
        });
    };
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.clear = /**
     * @return {?}
     */
    function () {
        this.storageCache = {};
        this.ngf.clear();
    };
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.pluginCheck = /**
     * @return {?}
     */
    function () {
        if (window['cordova'] && window['NativeStorage']) {
            this.nativeStorageI = window['NativeStorage'];
            // return true;
        }
        // this.initStorage();
    };
    /**
     * @param {?} key
     * @return {?}
     */
    NLocalStorageService.prototype.getItemNs = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.getItem(key, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    NLocalStorageService.prototype.setItemNs = /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    function (key, value) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.setItem(key, value, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    /**
     * @param {?} key
     * @return {?}
     */
    NLocalStorageService.prototype.removeItemNs = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.remove(key, function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.clearNs = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            if (window['cordova'] && window['NativeStorage']) {
                _this.nativeStorageI.clear(function (result) {
                    resolve(result);
                }, function (error) {
                    reject(error);
                });
            }
        });
    };
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.initNgForage = /**
     * @return {?}
     */
    function () {
        this.ngfConfig.configure({
            name: 'MyApp',
            driver: [
                NgForageConfig.DRIVER_WEBSQL,
            ]
        });
    };
    /**
     * @param {?} promise
     * @return {?}
     */
    NLocalStorageService.prototype.promiseReflect = /**
     * @param {?} promise
     * @return {?}
     */
    function (promise) {
        return promise.then(function (resolved) { return { v: resolved, status: 'resolved' }; }, function (error) { return { e: error, status: 'rejected' }; });
    };
    /**
     * @return {?}
     */
    NLocalStorageService.prototype.clearLocalStorage = /**
     * @return {?}
     */
    function () {
        this.remove('userObj');
        this.remove('accessToken');
        this.remove('refreshToken');
        this.remove('registrationId');
    };
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
    */
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
     * @return {?}
     */
    NLocalStorageService.prototype.checkDeviceId = /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
     * @return {?}
     */
    function () {
        var _this = this;
        if (NSystemService.getInstance().checkDevice() === 'browser') {
            this._deviceUUID = this.getValue('uuid');
            if (!this._deviceUUID) {
                this._deviceUUID = new NUtility().generateUUID();
                this.setValue('uuid', this._deviceUUID);
            }
        }
        else {
            window['plugins'].uniqueDeviceID.get(function (uuid) {
                _this._deviceUUID = uuid;
                _this.setValue('uuid', _this._deviceUUID);
            });
        }
        return this._deviceUUID;
    };
    Object.defineProperty(NLocalStorageService.prototype, "deviceUUID", {
        get: /**
         * @return {?}
         */
        function () {
            return this._deviceUUID;
        },
        enumerable: true,
        configurable: true
    });
    NLocalStorageService.decorators = [
        { type: Injectable },
    ];
    /** @nocollapse */
    NLocalStorageService.ctorParameters = function () { return [
        { type: NgForageConfig, },
        { type: NgForage, },
        { type: NgForageCache, },
    ]; };
    return NLocalStorageService;
}());
export { NLocalStorageService };
function NLocalStorageService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NLocalStorageService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NLocalStorageService.ctorParameters;
    /** @type {?} */
    NLocalStorageService.prototype.storageCache;
    /** @type {?} */
    NLocalStorageService.prototype._deviceUUID;
    /** @type {?} */
    NLocalStorageService.prototype.nativeStorageI;
    /** @type {?} */
    NLocalStorageService.prototype.ngfConfig;
    /** @type {?} */
    NLocalStorageService.prototype.ngf;
    /** @type {?} */
    NLocalStorageService.prototype.ngfCache;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2NhbFN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQWMsTUFBTSxVQUFVLENBQUM7QUFDL0UsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztJQVExQyw4QkFBb0IsU0FBMEIsRUFBbUIsR0FBYyxFQUFtQixRQUF3QjtRQUF0RyxjQUFTLEdBQVQsU0FBUyxDQUFpQjtRQUFtQixRQUFHLEdBQUgsR0FBRyxDQUFXO1FBQW1CLGFBQVEsR0FBUixRQUFRLENBQWdCOzRCQUh0RyxFQUFFO0tBSXJCOzs7O0lBSUQsMENBQVc7OztJQUFYO1FBQUEsaUJBY0M7UUFiQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUNqQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixLQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDckI7WUFDRCxLQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsY0FBYztnQkFDMUMsS0FBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7YUFDaEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07Z0JBQ1osS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dCQUNyQixNQUFNLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUE7YUFDekMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFBLEtBQUs7Z0JBQ1osTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN0QixDQUFDLENBQUE7U0FDSCxDQUFDLENBQUE7S0FDSDs7OztJQUVELHlDQUFVOzs7SUFBVjtRQUNFLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO0tBQzFCOzs7Ozs7SUFHRCx1Q0FBUTs7Ozs7SUFBUixVQUFTLEdBQUcsRUFBRSxLQUFLO1FBQ2pCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1NBQ3JCO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDL0IsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxNQUFNO1lBQzdDLE1BQU0sQ0FBQyxNQUFNLENBQUM7U0FDZixFQUFFLFVBQUEsS0FBSztZQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEIsQ0FBQyxDQUFBO0tBQ0g7Ozs7O0lBRUQsdUNBQVE7Ozs7SUFBUixVQUFTLEdBQUc7UUFDVixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxJQUFJLENBQUM7U0FDYjtRQUFDLElBQUksQ0FBQztZQUNMLHFCQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2xDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3hCO1FBQUMsS0FBSyxDQUFDLENBQUMsaUJBQUEsS0FBSyxFQUFFLENBQUM7WUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMvQjtLQUNGOzs7OztJQUVELHFDQUFNOzs7O0lBQU4sVUFBTyxHQUFHO1FBQVYsaUJBVUM7UUFUQyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDOUIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0QixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDckI7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxTQUFTO1lBQ3JDLE9BQU8sS0FBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN0QixDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUEsS0FBSztZQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDeEMsQ0FBQyxDQUFBO0tBQ0g7Ozs7SUFFRCxvQ0FBSzs7O0lBQUw7UUFDRSxJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQ2xCOzs7O0lBRU8sMENBQVc7Ozs7UUFDakIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7O1NBRS9DOzs7Ozs7O0lBSUssd0NBQVM7Ozs7Y0FBQyxHQUFHOztRQUNuQixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUNqQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakQsS0FBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFVBQUEsTUFBTTtvQkFDckMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNqQixFQUFFLFVBQUEsS0FBSztvQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ2YsQ0FBQyxDQUFBO2FBQ0g7U0FDRixDQUFDLENBQUE7Ozs7Ozs7SUFHSSx3Q0FBUzs7Ozs7Y0FBQyxHQUFHLEVBQUUsS0FBSzs7UUFDMUIsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDakMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pELEtBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsVUFBQSxNQUFNO29CQUM1QyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7aUJBQ2pCLEVBQUUsVUFBQSxLQUFLO29CQUNOLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDZixDQUFDLENBQUE7YUFDSDtTQUNGLENBQUMsQ0FBQTs7Ozs7O0lBR0ksMkNBQVk7Ozs7Y0FBQyxHQUFHOztRQUN0QixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUNqQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakQsS0FBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFVBQUMsTUFBTTtvQkFDckMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNqQixFQUFFLFVBQUMsS0FBSztvQkFDUCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ2YsQ0FBQyxDQUFDO2FBQ0o7U0FDRixDQUFDLENBQUE7Ozs7O0lBR0ksc0NBQU87Ozs7O1FBQ2IsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDakMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pELEtBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLFVBQUEsTUFBTTtvQkFDOUIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUNqQixFQUFFLFVBQUEsS0FBSztvQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ2YsQ0FBQyxDQUFBO2FBQ0g7U0FDRixDQUFDLENBQUE7Ozs7O0lBR0ksMkNBQVk7Ozs7UUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7WUFDdkIsSUFBSSxFQUFFLE9BQU87WUFDYixNQUFNLEVBQUU7Z0JBQ04sY0FBYyxDQUFDLGFBQWE7YUFDN0I7U0FDRixDQUFDLENBQUM7Ozs7OztJQUlHLDZDQUFjOzs7O2NBQUMsT0FBTztRQUM1QixNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFBLFFBQVEsSUFBTSxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQSxFQUFFLEVBQUUsVUFBQSxLQUFLLElBQU0sTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLENBQUEsRUFBRSxDQUFDLENBQUE7Ozs7O0lBR3ZJLGdEQUFpQjs7O0lBQWpCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQy9CO0lBRUQ7O01BRUU7Ozs7O0lBRUYsNENBQWE7Ozs7SUFBYjtRQUFBLGlCQWVDO1FBZEMsRUFBRSxDQUFDLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDLFdBQVcsRUFBRSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0QsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXpDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDakQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ3pDO1NBQ0Y7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLFVBQUMsSUFBSTtnQkFDeEMsS0FBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7Z0JBQ3hCLEtBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUN6QyxDQUFDLENBQUM7U0FDSjtRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO0tBQ3pCOzBCQUVVLDRDQUFVOzs7OztZQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQzs7Ozs7O2dCQTNLM0IsVUFBVTs7OztnQkFIdUIsY0FBYztnQkFBdkMsUUFBUTtnQkFBRSxhQUFhOzsrQkFIaEM7O1NBT2Esb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0ICogYXMgbG9jYWxmb3JhZ2UgZnJvbSAnbG9jYWxmb3JhZ2UnO1xuaW1wb3J0IHsgTmdGb3JhZ2UsIE5nRm9yYWdlQ2FjaGUsIE5nRm9yYWdlQ29uZmlnLCBDYWNoZWRJdGVtIH0gZnJvbSAnbmdmb3JhZ2UnO1xuaW1wb3J0IHsgTlV0aWxpdHkgfSBmcm9tICcuL24tdXRpbC5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIHtcblxuICBzdG9yYWdlQ2FjaGU6IGFueSA9IHt9O1xuICBwcml2YXRlIF9kZXZpY2VVVUlEO1xuICBwcml2YXRlIG5hdGl2ZVN0b3JhZ2VJO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nZkNvbmZpZz86IE5nRm9yYWdlQ29uZmlnLCBwcml2YXRlIHJlYWRvbmx5IG5nZj86IE5nRm9yYWdlLCBwcml2YXRlIHJlYWRvbmx5IG5nZkNhY2hlPzogTmdGb3JhZ2VDYWNoZSkge1xuICB9XG5cblxuXG4gIGluaXRTdG9yYWdlKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10pIHtcbiAgICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubmdmLml0ZXJhdGUoKHZhbHVlLCBrZXksIGl0ZXJhdG9uTnVtYmVyKSA9PiB7XG4gICAgICAgIHRoaXMuc3RvcmFnZUNhY2hlW2tleV0gPSB2YWx1ZTtcbiAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgdGhpcy5jaGVja0RldmljZUlkKCk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCdpdGVyYXRpb24gaXMgY29tcGxldGVkJylcbiAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBnZXRTdG9yYWdlKCkge1xuICAgIHJldHVybiB0aGlzLnN0b3JhZ2VDYWNoZTtcbiAgfVxuXG5cbiAgc2V0VmFsdWUoa2V5LCB2YWx1ZSkge1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xuICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICB9XG4gICAgdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSA9IHZhbHVlO1xuICAgIHJldHVybiB0aGlzLm5nZi5zZXRJdGVtKGtleSwgdmFsdWUpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwgZXJyb3IgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgIH0pXG4gIH1cblxuICBnZXRWYWx1ZShrZXkpOiBhbnkgfCBQcm9taXNlPGFueT4ge1xuICAgIGlmICghdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSB0cnkge1xuICAgICAgY29uc3Qgb2JqID0gdGhpcy5zdG9yYWdlQ2FjaGVba2V5XVxuICAgICAgcmV0dXJuIEpTT04ucGFyc2Uob2JqKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZUNhY2hlW2tleV07XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGtleSkge1xuICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldO1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xuICAgICAgdGhpcy5pbml0TmdGb3JhZ2UoKTtcbiAgICB9XG4gICAgdGhpcy5uZ2YucmVtb3ZlSXRlbShrZXkpLnRoZW4oZnVsZmlsbGVkID0+IHtcbiAgICAgIGRlbGV0ZSB0aGlzLm5nZltrZXldO1xuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0NvdWxkIG5vdCByZW1vdmUnLCBrZXkpO1xuICAgIH0pXG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLnN0b3JhZ2VDYWNoZSA9IHt9O1xuICAgIHRoaXMubmdmLmNsZWFyKCk7XG4gIH1cblxuICBwcml2YXRlIHBsdWdpbkNoZWNrKCkge1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSSA9IHdpbmRvd1snTmF0aXZlU3RvcmFnZSddO1xuICAgICAgLy8gcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8vIHRoaXMuaW5pdFN0b3JhZ2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SXRlbU5zKGtleSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5nZXRJdGVtKGtleSwgcmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHNldEl0ZW1OcyhrZXksIHZhbHVlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLnNldEl0ZW0oa2V5LCB2YWx1ZSwgcmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUl0ZW1OcyhrZXkpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkucmVtb3ZlKGtleSwgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgY2xlYXJOcygpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkuY2xlYXIocmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGluaXROZ0ZvcmFnZSgpIHtcbiAgICB0aGlzLm5nZkNvbmZpZy5jb25maWd1cmUoe1xuICAgICAgbmFtZTogJ015QXBwJyxcbiAgICAgIGRyaXZlcjogW1xuICAgICAgICBOZ0ZvcmFnZUNvbmZpZy5EUklWRVJfV0VCU1FMLFxuICAgICAgXVxuICAgIH0pO1xuXG4gIH1cblxuICBwcml2YXRlIHByb21pc2VSZWZsZWN0KHByb21pc2UpIHtcbiAgICByZXR1cm4gcHJvbWlzZS50aGVuKHJlc29sdmVkID0+IHsgcmV0dXJuIHsgdjogcmVzb2x2ZWQsIHN0YXR1czogJ3Jlc29sdmVkJyB9IH0sIGVycm9yID0+IHsgcmV0dXJuIHsgZTogZXJyb3IsIHN0YXR1czogJ3JlamVjdGVkJyB9IH0pXG4gIH1cblxuICBjbGVhckxvY2FsU3RvcmFnZSgpIHtcbiAgICB0aGlzLnJlbW92ZSgndXNlck9iaicpO1xuICAgIHRoaXMucmVtb3ZlKCdhY2Nlc3NUb2tlbicpO1xuICAgIHRoaXMucmVtb3ZlKCdyZWZyZXNoVG9rZW4nKTtcbiAgICB0aGlzLnJlbW92ZSgncmVnaXN0cmF0aW9uSWQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEdWUgdG8gdGltaW5nIGlzc3VlcyBhbmQgY2lyY3VsYXIgZGVwZW5kZW5jeSBjaGVja0RldmljZUlkIGlzIG1vdmVkIGZyb20gTlN5c3RlbVNlcnZpY2VcbiAgKi9cblxuICBjaGVja0RldmljZUlkKCkge1xuICAgIGlmIChOU3lzdGVtU2VydmljZS5nZXRJbnN0YW5jZSgpLmNoZWNrRGV2aWNlKCkgPT09ICdicm93c2VyJykge1xuICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IHRoaXMuZ2V0VmFsdWUoJ3V1aWQnKTtcblxuICAgICAgaWYgKCF0aGlzLl9kZXZpY2VVVUlEKSB7XG4gICAgICAgIHRoaXMuX2RldmljZVVVSUQgPSBuZXcgTlV0aWxpdHkoKS5nZW5lcmF0ZVVVSUQoKTtcbiAgICAgICAgdGhpcy5zZXRWYWx1ZSgndXVpZCcsIHRoaXMuX2RldmljZVVVSUQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB3aW5kb3dbJ3BsdWdpbnMnXS51bmlxdWVEZXZpY2VJRC5nZXQoKHV1aWQpID0+IHtcbiAgICAgICAgdGhpcy5fZGV2aWNlVVVJRCA9IHV1aWQ7XG4gICAgICAgIHRoaXMuc2V0VmFsdWUoJ3V1aWQnLCB0aGlzLl9kZXZpY2VVVUlEKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlVVVJRDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZGV2aWNlVVVJRCgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGV2aWNlVVVJRDtcbiAgfVxufVxuIl19