/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable, Injector } from '@angular/core';
import { HttpHeaders, HttpErrorResponse, HttpClient } from '@angular/common/http';
import { Observable, BehaviorSubject } from 'rxjs/Rx';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
import { NSystemService } from './n-system.service';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NLocalStorageService } from './n-localStorage.service';
import { NTokenService } from './n-token.service';
import { NPubSubService } from './n-pubSub.service';
var NHttpService = /** @class */ (function () {
    function NHttpService(nHTTPLoader, inj, nLocalStorageService, nTokenService) {
        this.nHTTPLoader = nHTTPLoader;
        this.inj = inj;
        this.nLocalStorageService = nLocalStorageService;
        this.nTokenService = nTokenService;
        this.timeout = 90000;
        this.isRefreshingToken = false;
        this.tokenSubject = new BehaviorSubject(null);
        this.systemService = NSystemService.getInstance();
        this.nSessionStorage = new NSessionStorageService();
        this.appProperties = this.systemService.getVal('properties');
        this.nPubSubService = new NPubSubService();
    }
    /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    NHttpService.prototype.intercept = /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    function (req, next) {
        var _this = this;
        this.requestInterceptor();
        // Pass on the cloned request instead of the original request.
        return next.handle(this.requestOptions(req))
            .timeout(this.timeout)
            .catch(function (error) { return _this.onCatch(error, req, next); })
            .finally(function () {
            _this.onFinally();
        });
    };
    ;
    /**
     * @param {?} error
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    NHttpService.prototype.updateToken = /**
     * @param {?} error
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    function (error, req, next) {
        var _this = this;
        if (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
            this.appProperties.appAuthenticationStrategy === 'localAuth') {
            if (!this.isRefreshingToken) {
                this.isRefreshingToken = true;
                // Reset here so that the following requests wait until the token
                // comes back from the refreshToken call.
                this.tokenSubject.next(null);
                return this.refreshToken()
                    .switchMap(function (tokensObj) {
                    if (tokensObj) {
                        _this.nTokenService.updateTokens(tokensObj);
                        var /** @type {?} */ newToken = tokensObj['accessToken'];
                        _this.tokenSubject.next(newToken);
                        return next.handle(_this.requestOptions(req));
                    }
                    return Observable.throw(new Error('Can\'t refresh the token'));
                })
                    .catch(function (err) { return _this.onCatchError(err); })
                    .finally(function () { return _this.isRefreshingToken = false; });
            }
            else {
                return this.tokenSubject
                    .filter(function (token) { return token != null; })
                    .take(1)
                    .switchMap(function (token) { return next.handle(_this.requestOptions(req)); });
            }
        }
        else {
            return this.onCatchError(error);
        }
    };
    /**
     * @return {?}
     */
    NHttpService.prototype.refreshToken = /**
     * @return {?}
     */
    function () {
        var /** @type {?} */ http = this.inj.get(HttpClient);
        var /** @type {?} */ appProperties = this.systemService.getVal('properties');
        var /** @type {?} */ refreshUrl = this.systemService.getAuthUrl() + appProperties.appName + '/refresh';
        var /** @type {?} */ body = {
            'platformDetails': this.systemService.getPlatformDetails(this.systemService.checkDevice()),
            'userKey': this.nSessionStorage.getValue('userObj')['userKey'],
            'refreshToken': this.nSessionStorage.getValue('refreshToken')
        };
        body.platformDetails['uuid'] = this.nLocalStorageService.getValue('uuid');
        return http.post(refreshUrl, body);
    };
    /**
     * Request options.
     * @param {?=} req
     * @return {?} HttpRequest
     */
    NHttpService.prototype.requestOptions = /**
     * Request options.
     * @param {?=} req
     * @return {?} HttpRequest
     */
    function (req) {
        var /** @type {?} */ headers = req.headers;
        if (req.headers == null) {
            headers = new HttpHeaders();
        }
        req = req.clone({
            url: this.getFullUrl(req.url),
            headers: headers
        });
        var /** @type {?} */ baseUrl = NSystemService.getInstance().getVal('baseUrl');
        var /** @type {?} */ isArt = (baseUrl !== '' && req.url.includes(baseUrl));
        return isArt ? this.addDefaultHeaders(req) : req;
    };
    /**
     * Default options.
     * @param {?} req
     * @return {?} HttpHeadedrs
     */
    NHttpService.prototype.addDefaultHeaders = /**
     * Default options.
     * @param {?} req
     * @return {?} HttpHeadedrs
     */
    function (req) {
        /**
             * TODO: Add all default Headers over here
             */
        if (!req.headers.has('Access-Control-Allow-Origin')) {
            req.headers = req.headers.set('Access-Control-Allow-Origin', '*');
        }
        if (!req.headers.has('Content-Type')) {
            req.headers = req.headers.set('Content-Type', 'application/json');
        }
        else if (req.headers.has('Content-Type') && (req.headers.get('Content-Type') === 'no-content')) {
            req.headers = req.headers.delete('Content-Type');
        }
        if (!req.headers.has('Accept')) {
            req.headers = req.headers.set('Accept', 'application/json');
        }
        if (!req.headers.has('Authorization')) {
            this.appProperties = this.systemService.getVal('properties');
            if (this.appProperties && this.appProperties.appAuthenticationStrategy === 'basicAuth') {
                var /** @type {?} */ username = void 0, /** @type {?} */ password = void 0;
                if (this.appProperties.basicAuthUser && this.appProperties.basicAuthPassword) {
                    username = this.appProperties.basicAuthUser;
                    password = this.appProperties.basicAuthPassword;
                }
                else {
                    username = "bhive-art-proxyuser";
                    password = "password";
                    console.warn("Authentication strategy: Basic Auth. basicAuthUser and basicAuthPassword are not configured in environment. Setting default values.");
                }
                req.headers = req.headers.set('Authorization', 'Basic ' + btoa(username + ":" + password));
            }
            else if (this.appProperties && (this.appProperties.appAuthenticationStrategy === 'activeDirectory' ||
                this.appProperties.appAuthenticationStrategy === 'localAuth')) {
                if (this.nSessionStorage.getValue('accessToken')) {
                    req.headers = req.headers.set('Authorization', 'Bearer ' + this.nSessionStorage.getValue('accessToken'));
                }
            }
        }
        return req;
    };
    /**
     * Build API url.
     * @param {?} url
     * @return {?} string
     */
    NHttpService.prototype.getFullUrl = /**
     * Build API url.
     * @param {?} url
     * @return {?} string
     */
    function (url) {
        // return full URL to API here
        return url;
    };
    /**
     * Request interceptor.
     * @return {?}
     */
    NHttpService.prototype.requestInterceptor = /**
     * Request interceptor.
     * @return {?}
     */
    function () {
        this.nHTTPLoader.isHTTPRequestInProgress(true);
    };
    /**
     * Response interceptor.
     * @return {?}
     */
    NHttpService.prototype.responseInterceptor = /**
     * Response interceptor.
     * @return {?}
     */
    function () {
        this.nHTTPLoader.isHTTPRequestInProgress(false);
    };
    /**
     * Error handler.
     * @param {?} error
     * @param {?} req
     * @param {?} next
     * @return {?} ErrorObservable
     */
    NHttpService.prototype.onCatch = /**
     * Error handler.
     * @param {?} error
     * @param {?} req
     * @param {?} next
     * @return {?} ErrorObservable
     */
    function (error, req, next) {
        if (error instanceof HttpErrorResponse) {
            if ((/** @type {?} */ (error)).status === 403 && (/** @type {?} */ (error)).error.message === 'jwt expired') {
                return this.updateToken(error, req, next);
            }
            else {
                return this.onSubscribeError(error);
            }
        }
        else {
            return this.onSubscribeError(error);
        }
    };
    /**
     * onSubscribeError
     * @param {?} err
     * @return {?}
     */
    NHttpService.prototype.onSubscribeError = /**
     * onSubscribeError
     * @param {?} err
     * @return {?}
     */
    function (err) {
        this.nHTTPLoader.alertError(err);
        return this.onCatchError(err);
    };
    /**
     * onFinally
     * @return {?}
     */
    NHttpService.prototype.onFinally = /**
     * onFinally
     * @return {?}
     */
    function () {
        this.responseInterceptor();
    };
    /**
     * @param {?} error
     * @return {?}
     */
    NHttpService.prototype.onCatchError = /**
     * @param {?} error
     * @return {?}
     */
    function (error) {
        return Observable.throw(error);
    };
    NHttpService.decorators = [
        { type: Injectable },
    ];
    /** @nocollapse */
    NHttpService.ctorParameters = function () { return [
        { type: NHTTPLoaderService, },
        { type: Injector, },
        { type: NLocalStorageService, },
        { type: NTokenService, },
    ]; };
    return NHttpService;
}());
export { NHttpService };
function NHttpService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NHttpService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NHttpService.ctorParameters;
    /** @type {?} */
    NHttpService.prototype.timeout;
    /** @type {?} */
    NHttpService.prototype.systemService;
    /** @type {?} */
    NHttpService.prototype.nSessionStorage;
    /** @type {?} */
    NHttpService.prototype.appProperties;
    /** @type {?} */
    NHttpService.prototype.isRefreshingToken;
    /** @type {?} */
    NHttpService.prototype.nPubSubService;
    /** @type {?} */
    NHttpService.prototype.tokenSubject;
    /** @type {?} */
    NHttpService.prototype.nHTTPLoader;
    /** @type {?} */
    NHttpService.prototype.inj;
    /** @type {?} */
    NHttpService.prototype.nLocalStorageService;
    /** @type {?} */
    NHttpService.prototype.nTokenService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1IVFRQLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvbi1IVFRQLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFLTCxXQUFXLEVBRVgsaUJBQWlCLEVBQ2pCLFVBQVUsRUFDWCxNQUFNLHNCQUFzQixDQUFDO0FBQzlCLE9BQU8sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDOztJQVlsRCxzQkFBb0IsV0FBK0IsRUFBVSxHQUFhLEVBQ2hFLHNCQUFvRCxhQUE0QjtRQUR0RSxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUFVO1FBQ2hFLHlCQUFvQixHQUFwQixvQkFBb0I7UUFBZ0Msa0JBQWEsR0FBYixhQUFhLENBQWU7dUJBVGhGLEtBQUs7aUNBSUssS0FBSzs0QkFFZSxJQUFJLGVBQWUsQ0FBUyxJQUFJLENBQUM7UUFJdkUsSUFBSSxDQUFDLGFBQWEsR0FBRyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLHNC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LENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUMzQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDckM7U0FDRjtRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQzs7Ozs7OztJQU9LLHVDQUFnQjs7Ozs7Y0FBQyxHQUFzQjtRQUM3QyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzs7Ozs7O0lBS3hCLGdDQUFTOzs7OztRQUNmLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDOzs7Ozs7SUFHckIsbUNBQVk7Ozs7Y0FBQyxLQUF3QjtRQUMzQyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzs7O2dCQTFNbEMsVUFBVTs7OztnQkFQRixrQkFBa0I7Z0JBWk4sUUFBUTtnQkFlcEIsb0JBQW9CO2dCQUNwQixhQUFhOzt1QkFoQnRCOztTQW9CYSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEh0dHBFdmVudCxcbiAgSHR0cEludGVyY2VwdG9yLFxuICBIdHRwSGFuZGxlcixcbiAgSHR0cFJlcXVlc3QsXG4gIEh0dHBIZWFkZXJzLFxuICBIdHRwUmVzcG9uc2UsXG4gIEh0dHBFcnJvclJlc3BvbnNlLFxuICBIdHRwQ2xpZW50XG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMvUngnO1xuaW1wb3J0IHsgTkhUVFBMb2FkZXJTZXJ2aWNlIH0gZnJvbSAnLi9uLUhUVFBMb2FkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBOU3lzdGVtU2VydmljZSB9IGZyb20gJy4vbi1zeXN0ZW0uc2VydmljZSc7XG5pbXBvcnQgeyBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLXNlc3Npb25TdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTkxvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL24tbG9jYWxTdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTlRva2VuU2VydmljZSB9IGZyb20gJy4vbi10b2tlbi5zZXJ2aWNlJztcbmltcG9ydCB7IE5QdWJTdWJTZXJ2aWNlIH0gZnJvbSAnLi9uLXB1YlN1Yi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5IdHRwU2VydmljZSB7XG4gIHRpbWVvdXQgPSA5MDAwMDtcbiAgc3lzdGVtU2VydmljZTtcbiAgblNlc3Npb25TdG9yYWdlO1xuICBhcHBQcm9wZXJ0aWVzO1xuICBpc1JlZnJlc2hpbmdUb2tlbiA9IGZhbHNlO1xuICBuUHViU3ViU2VydmljZTtcbiAgdG9rZW5TdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPihudWxsKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5IVFRQTG9hZGVyOiBOSFRUUExvYWRlclNlcnZpY2UsIHByaXZhdGUgaW5qOiBJbmplY3RvcixcbiAgICBwcml2YXRlIG5Mb2NhbFN0b3JhZ2VTZXJ2aWNlOiBOTG9jYWxTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBuVG9rZW5TZXJ2aWNlOiBOVG9rZW5TZXJ2aWNlKSB7XG4gICAgdGhpcy5zeXN0ZW1TZXJ2aWNlID0gTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICB0aGlzLm5TZXNzaW9uU3RvcmFnZSA9IG5ldyBOU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlKCk7XG4gICAgdGhpcy5hcHBQcm9wZXJ0aWVzID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHJvcGVydGllcycpO1xuICAgIHRoaXMublB1YlN1YlNlcnZpY2UgPSBuZXcgTlB1YlN1YlNlcnZpY2UoKTtcbiAgfVxuXG4gIGludGVyY2VwdChyZXE6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIHRoaXMucmVxdWVzdEludGVyY2VwdG9yKCk7XG5cbiAgICAvLyBQYXNzIG9uIHRoZSBjbG9uZWQgcmVxdWVzdCBpbnN0ZWFkIG9mIHRoZSBvcmlnaW5hbCByZXF1ZXN0LlxuICAgIHJldHVybiBuZXh0LmhhbmRsZSh0aGlzLnJlcXVlc3RPcHRpb25zKHJlcSkpXG4gICAgICAudGltZW91dCh0aGlzLnRpbWVvdXQpXG4gICAgICAuY2F0Y2goZXJyb3IgPT4gdGhpcy5vbkNhdGNoKGVycm9yLCByZXEsIG5leHQpKVxuICAgICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICB0aGlzLm9uRmluYWxseSgpO1xuICAgICAgfSk7XG4gIH07XG5cbiAgdXBkYXRlVG9rZW4oZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlLCByZXE6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogYW55IHtcbiAgICBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzLmFwcEF1dGhlbnRpY2F0aW9uU3RyYXRlZ3kgPT09ICdhY3RpdmVEaXJlY3RvcnknIHx8XG4gICAgICB0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2xvY2FsQXV0aCcpIHtcbiAgICAgIGlmICghdGhpcy5pc1JlZnJlc2hpbmdUb2tlbikge1xuICAgICAgICB0aGlzLmlzUmVmcmVzaGluZ1Rva2VuID0gdHJ1ZTtcblxuICAgICAgICAvLyBSZXNldCBoZXJlIHNvIHRoYXQgdGhlIGZvbGxvd2luZyByZXF1ZXN0cyB3YWl0IHVudGlsIHRoZSB0b2tlblxuICAgICAgICAvLyBjb21lcyBiYWNrIGZyb20gdGhlIHJlZnJlc2hUb2tlbiBjYWxsLlxuICAgICAgICB0aGlzLnRva2VuU3ViamVjdC5uZXh0KG51bGwpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnJlZnJlc2hUb2tlbigpXG4gICAgICAgICAgLnN3aXRjaE1hcCgodG9rZW5zT2JqOiBPYmplY3QpID0+IHtcbiAgICAgICAgICAgIGlmICh0b2tlbnNPYmopIHtcbiAgICAgICAgICAgICAgdGhpcy5uVG9rZW5TZXJ2aWNlLnVwZGF0ZVRva2Vucyh0b2tlbnNPYmopO1xuICAgICAgICAgICAgICBjb25zdCBuZXdUb2tlbiA9IHRva2Vuc09ialsnYWNjZXNzVG9rZW4nXTtcbiAgICAgICAgICAgICAgdGhpcy50b2tlblN1YmplY3QubmV4dChuZXdUb2tlbik7XG4gICAgICAgICAgICAgIHJldHVybiBuZXh0LmhhbmRsZSh0aGlzLnJlcXVlc3RPcHRpb25zKHJlcSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3cobmV3IEVycm9yKCdDYW5cXCd0IHJlZnJlc2ggdGhlIHRva2VuJykpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiB0aGlzLm9uQ2F0Y2hFcnJvcihlcnIpKVxuICAgICAgICAgIC5maW5hbGx5KCgpID0+IHRoaXMuaXNSZWZyZXNoaW5nVG9rZW4gPSBmYWxzZSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRva2VuU3ViamVjdFxuICAgICAgICAgIC5maWx0ZXIodG9rZW4gPT4gdG9rZW4gIT0gbnVsbClcbiAgICAgICAgICAudGFrZSgxKVxuICAgICAgICAgIC5zd2l0Y2hNYXAodG9rZW4gPT4gbmV4dC5oYW5kbGUodGhpcy5yZXF1ZXN0T3B0aW9ucyhyZXEpKSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLm9uQ2F0Y2hFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcmVmcmVzaFRva2VuKCkge1xuICAgIGNvbnN0IGh0dHAgPSB0aGlzLmluai5nZXQoSHR0cENsaWVudCk7XG4gICAgY29uc3QgYXBwUHJvcGVydGllcyA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ3Byb3BlcnRpZXMnKTtcbiAgICBjb25zdCByZWZyZXNoVXJsID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldEF1dGhVcmwoKSArIGFwcFByb3BlcnRpZXMuYXBwTmFtZSArICcvcmVmcmVzaCc7XG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgICdwbGF0Zm9ybURldGFpbHMnOiB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0UGxhdGZvcm1EZXRhaWxzKHRoaXMuc3lzdGVtU2VydmljZS5jaGVja0RldmljZSgpKSxcbiAgICAgICd1c2VyS2V5JzogdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ3VzZXJPYmonKVsndXNlcktleSddLFxuICAgICAgJ3JlZnJlc2hUb2tlbic6IHRoaXMublNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCdyZWZyZXNoVG9rZW4nKVxuICAgIH07XG4gICAgYm9keS5wbGF0Zm9ybURldGFpbHNbJ3V1aWQnXSA9IHRoaXMubkxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0VmFsdWUoJ3V1aWQnKTtcbiAgICByZXR1cm4gaHR0cC5wb3N0KHJlZnJlc2hVcmwsIGJvZHkpO1xuICB9XG5cblxuICAvKipcbiAgICogUmVxdWVzdCBvcHRpb25zLlxuICAgKiBAcGFyYW0gb3B0aW9uc1xuICAgKiBAcmV0dXJucyBIdHRwUmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSByZXF1ZXN0T3B0aW9ucyhyZXE/OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgbGV0IGhlYWRlcnMgPSByZXEuaGVhZGVycztcbiAgICBpZiAocmVxLmhlYWRlcnMgPT0gbnVsbCkge1xuICAgICAgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgIH1cbiAgICByZXEgPSByZXEuY2xvbmUoe1xuICAgICAgdXJsOiB0aGlzLmdldEZ1bGxVcmwocmVxLnVybCksXG4gICAgICBoZWFkZXJzOiBoZWFkZXJzXG4gICAgfSk7XG4gICAgY29uc3QgYmFzZVVybCA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCkuZ2V0VmFsKCdiYXNlVXJsJyk7XG4gICAgY29uc3QgaXNBcnQgPSAoYmFzZVVybCAhPT0gJycgJiYgcmVxLnVybC5pbmNsdWRlcyhiYXNlVXJsKSk7XG4gICAgcmV0dXJuICBpc0FydCA/IHRoaXMuYWRkRGVmYXVsdEhlYWRlcnMocmVxKSA6IHJlcTtcbiAgfVxuXG5cbiAgLyoqXG4gICogRGVmYXVsdCBvcHRpb25zLlxuICAqIEBwYXJhbSBvcHRpb25zXG4gICogQHJldHVybnMgSHR0cEhlYWRlZHJzXG4gICovXG4gIHByaXZhdGUgYWRkRGVmYXVsdEhlYWRlcnMocmVxOiBhbnkpIHtcbiAgICAvKipcbiAgICAgKiBUT0RPOiBBZGQgYWxsIGRlZmF1bHQgSGVhZGVycyBvdmVyIGhlcmVcbiAgICAgKi9cbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJykpIHtcbiAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nLCAnKicpO1xuICAgIH1cblxuICAgIGlmICghcmVxLmhlYWRlcnMuaGFzKCdDb250ZW50LVR5cGUnKSkge1xuICAgICAgcmVxLmhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgfSBlbHNlIGlmIChyZXEuaGVhZGVycy5oYXMoJ0NvbnRlbnQtVHlwZScpICYmIChyZXEuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpID09PSAnbm8tY29udGVudCcpKSB7XG4gICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLmRlbGV0ZSgnQ29udGVudC1UeXBlJyk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXEuaGVhZGVycy5oYXMoJ0FjY2VwdCcpKSB7XG4gICAgICByZXEuaGVhZGVycyA9IHJlcS5oZWFkZXJzLnNldCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICB9XG5cbiAgICBpZiAoIXJlcS5oZWFkZXJzLmhhcygnQXV0aG9yaXphdGlvbicpKSB7XG4gICAgICB0aGlzLmFwcFByb3BlcnRpZXMgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwcm9wZXJ0aWVzJyk7XG4gICAgICBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzICYmIHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYmFzaWNBdXRoJykge1xuICAgICAgICBsZXQgdXNlcm5hbWUsIHBhc3N3b3JkO1xuICAgICAgICBpZiAodGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFVzZXIgJiYgdGhpcy5hcHBQcm9wZXJ0aWVzLmJhc2ljQXV0aFBhc3N3b3JkKSB7XG4gICAgICAgICAgdXNlcm5hbWUgPSB0aGlzLmFwcFByb3BlcnRpZXMuYmFzaWNBdXRoVXNlcjtcbiAgICAgICAgICBwYXNzd29yZCA9IHRoaXMuYXBwUHJvcGVydGllcy5iYXNpY0F1dGhQYXNzd29yZDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICB1c2VybmFtZSA9IFwiYmhpdmUtYXJ0LXByb3h5dXNlclwiO1xuICAgICAgICAgIHBhc3N3b3JkID0gXCJwYXNzd29yZFwiO1xuICAgICAgICAgIGNvbnNvbGUud2FybihcIkF1dGhlbnRpY2F0aW9uIHN0cmF0ZWd5OiBCYXNpYyBBdXRoLiBiYXNpY0F1dGhVc2VyIGFuZCBiYXNpY0F1dGhQYXNzd29yZCBhcmUgbm90IGNvbmZpZ3VyZWQgaW4gZW52aXJvbm1lbnQuIFNldHRpbmcgZGVmYXVsdCB2YWx1ZXMuXCIpO1xuICAgICAgICB9XG4gICAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ0Jhc2ljICcgKyBidG9hKHVzZXJuYW1lICsgXCI6XCIgKyBwYXNzd29yZCkpO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmFwcFByb3BlcnRpZXMgJiYgKHRoaXMuYXBwUHJvcGVydGllcy5hcHBBdXRoZW50aWNhdGlvblN0cmF0ZWd5ID09PSAnYWN0aXZlRGlyZWN0b3J5JyB8fFxuICAgICAgICB0aGlzLmFwcFByb3BlcnRpZXMuYXBwQXV0aGVudGljYXRpb25TdHJhdGVneSA9PT0gJ2xvY2FsQXV0aCcpKSB7XG4gICAgICAgIGlmICh0aGlzLm5TZXNzaW9uU3RvcmFnZS5nZXRWYWx1ZSgnYWNjZXNzVG9rZW4nKSkge1xuICAgICAgICAgIHJlcS5oZWFkZXJzID0gcmVxLmhlYWRlcnMuc2V0KCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgdGhpcy5uU2Vzc2lvblN0b3JhZ2UuZ2V0VmFsdWUoJ2FjY2Vzc1Rva2VuJykpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXE7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgQVBJIHVybC5cbiAgICogQHBhcmFtIHVybFxuICAgKiBAcmV0dXJucyBzdHJpbmdcbiAgICovXG4gIHByaXZhdGUgZ2V0RnVsbFVybCh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gcmV0dXJuIGZ1bGwgVVJMIHRvIEFQSSBoZXJlXG4gICAgcmV0dXJuIHVybDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0IGludGVyY2VwdG9yLlxuICAgKi9cbiAgcHJpdmF0ZSByZXF1ZXN0SW50ZXJjZXB0b3IoKTogdm9pZCB7XG4gICAgdGhpcy5uSFRUUExvYWRlci5pc0hUVFBSZXF1ZXN0SW5Qcm9ncmVzcyh0cnVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNwb25zZSBpbnRlcmNlcHRvci5cbiAgICovXG4gIHByaXZhdGUgcmVzcG9uc2VJbnRlcmNlcHRvcigpOiB2b2lkIHtcbiAgICB0aGlzLm5IVFRQTG9hZGVyLmlzSFRUUFJlcXVlc3RJblByb2dyZXNzKGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgICogRXJyb3IgaGFuZGxlci5cbiAgICAqIEBwYXJhbSBlcnJvclxuICAgICogQHBhcmFtIGNhdWdodFxuICAgICogQHJldHVybnMgRXJyb3JPYnNlcnZhYmxlXG4gICAgKi9cbiAgcHJpdmF0ZSBvbkNhdGNoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSwgcmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICAgIGlmICgoPEh0dHBFcnJvclJlc3BvbnNlPmVycm9yKS5zdGF0dXMgPT09IDQwMyAmJiAoPEh0dHBFcnJvclJlc3BvbnNlPmVycm9yKS5lcnJvci5tZXNzYWdlID09PSAnand0IGV4cGlyZWQnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVRva2VuKGVycm9yLCByZXEsIG5leHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub25TdWJzY3JpYmVFcnJvcihlcnJvcik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLm9uU3Vic2NyaWJlRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBvblN1YnNjcmliZUVycm9yXG4gICAqIEBwYXJhbSBlcnJvclxuICAgKi9cbiAgcHJpdmF0ZSBvblN1YnNjcmliZUVycm9yKGVycjogSHR0cEVycm9yUmVzcG9uc2UpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHRoaXMubkhUVFBMb2FkZXIuYWxlcnRFcnJvcihlcnIpO1xuICAgIHJldHVybiB0aGlzLm9uQ2F0Y2hFcnJvcihlcnIpO1xuICB9XG4gIC8qKlxuICAgKiBvbkZpbmFsbHlcbiAgICovXG4gIHByaXZhdGUgb25GaW5hbGx5KCk6IHZvaWQge1xuICAgIHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcigpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkNhdGNoRXJyb3IoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gIH1cblxufVxuIl19