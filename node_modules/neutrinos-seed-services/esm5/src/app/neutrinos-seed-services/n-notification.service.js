/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { NLocalStorageService } from './n-localStorage.service';
import * as firebase from 'firebase';
import { NPubSubService } from './n-pubSub.service';
import { HttpClient } from '@angular/common/http';
import { NSessionStorageService } from './n-sessionStorage.service';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
var NNotificationService = /** @class */ (function () {
    function NNotificationService(localStorageService, pubSubService, http, bHttpLoader) {
        var _this = this;
        this.localStorageService = localStorageService;
        this.pubSubService = pubSubService;
        this.http = http;
        this.bHttpLoader = bHttpLoader;
        this.systemService = NSystemService.getInstance();
        this.possiblePushTypes = ['APNS', 'FCM'];
        this.firebaseSenderId = this.systemService.getVal('firebaseSenderId');
        this.isNotificationEnabled = this.systemService.getVal('isNotificationEnabled');
        this.appName = this.systemService.getVal('appName');
        this.deviceType = this.systemService.deviceType;
        this.sessionStorage = new NSessionStorageService();
        this.loginSubscribe = this.pubSubService.$sub('firebaseRegister', function () {
            _this.enableNotification();
        });
    }
    /**
     * @return {?}
     */
    NNotificationService.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    NNotificationService.prototype.enableNotification = /**
     * @return {?}
     */
    function () {
        var _this = this;
        var /** @type {?} */ pushType = this.getPushType(this.systemService.getVal('pushType'));
        document.addEventListener('deviceready', function (event) {
            if (_this.isNotificationEnabled) {
                if (_this.deviceType && _this.deviceType != 'browser') {
                    _this.deviceType = _this.systemService.deviceType;
                    _this.checkPermission(pushType).then(function (res) {
                        if (res) {
                            _this.initializeNotifications(pushType);
                        }
                    });
                }
            }
        });
        if (this.isNotificationEnabled && pushType !== 'APNS') {
            if (this.deviceType && this.deviceType == 'browser' && window['Notification']) {
                this.initialiseWebPush();
            }
        }
    };
    /**
     * @return {?}
     */
    NNotificationService.prototype.initialiseWebPush = /**
     * @return {?}
     */
    function () {
        var /** @type {?} */ __this = this;
        var /** @type {?} */ messaging = firebase.messaging();
        messaging.requestPermission()
            .then(function () {
            return messaging.getToken();
        })
            .then(function (token) {
            if (token) {
                __this.sendRegDetails(token);
            }
        })
            .catch(function (err) {
            __this.bHttpLoader.alertError(err);
        });
        messaging.onMessage(function (payload) {
            if (payload['notification']) {
                var /** @type {?} */ notificationObj = payload['notification'];
                var /** @type {?} */ options = {
                    body: notificationObj.body,
                    icon: notificationObj.icon
                };
                // creating a native browser message
                var /** @type {?} */ notificationUI = new Notification(notificationObj.title, options);
                notificationUI.onclick = function () {
                    window.focus(); // window is focused when the user clicks the notification using this
                };
            }
        });
    };
    /**
     * @param {?=} pushType
     * @return {?}
     */
    NNotificationService.prototype.checkPermission = /**
     * @param {?=} pushType
     * @return {?}
     */
    function (pushType) {
        var _this = this;
        // Android & iOS only
        // Checks whether the push notification permission has been granted.
        return new Promise(function (resolve) {
            pushType = _this.getPushType(pushType);
            if ((_this.deviceType === 'Android' || _this.deviceType === 'iOS') && (pushType === 'FCM')) {
                PushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else if (_this.deviceType === 'iOS' && pushType === 'APNS') {
                APNSPushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else {
                return resolve(true);
            }
        });
    };
    /**
     * @param {?=} pushType
     * @return {?}
     */
    NNotificationService.prototype.initializeNotifications = /**
     * @param {?=} pushType
     * @return {?}
     */
    function (pushType) {
        var _this = this;
        //pushType = pushType ? pushType : 'FCM';
        pushType = this.getPushType(pushType);
        var /** @type {?} */ push;
        // Default if for FCM
        if (pushType === 'FCM') {
            push = window['PushNotification'].init({
                android: {
                    senderID: this.firebaseSenderId
                },
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true",
                    senderID: this.firebaseSenderId
                },
            });
        }
        else if (pushType === 'APNS') {
            push = window['APNSPushNotification'].init({
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true"
                }
            });
        }
        push.on('registration', function (data) {
            // data.registrationId
            // data.registrationId
            _this.sendRegDetails(data.registrationId);
        });
        // ToDo Christy get call back function from app user to change what happens once a notification arrives
        push.on('notification', function (data) {
            window['cordova'].plugins.notification.local.schedule({
                title: data.title,
                text: data.message,
                sound: data.sound,
                at: new Date().getTime()
            });
        });
        push.on('error', function (e) {
            // e.message
            console.error(e);
        });
    };
    /**
     * @param {?} registrationId
     * @return {?}
     */
    NNotificationService.prototype.sendRegDetails = /**
     * @param {?} registrationId
     * @return {?}
     */
    function (registrationId) {
        this.localStorageService.setValue('registrationId', registrationId);
        var /** @type {?} */ url = this.systemService.getTenantUrl() + 'notification/' + this.systemService.getVal('appName') + '/register';
        var /** @type {?} */ pushType = this.getPushType(this.systemService.getVal('pushType'));
        this.http.post(url, {
            'key': this.sessionStorage.getValue('userObj')['userKey'],
            'uuid': this.localStorageService.getValue('uuid'),
            'fbregid': registrationId,
            'pushType': pushType
        }).subscribe(function (result) {
            // this.pubSubService.$pub('FBRegComp');
        }, function (error) {
            console.log(error);
        });
    };
    /**
     * @param {?} currPushType
     * @return {?}
     */
    NNotificationService.prototype.getPushType = /**
     * @param {?} currPushType
     * @return {?}
     */
    function (currPushType) {
        var /** @type {?} */ isValidPush = typeof currPushType !== 'undefined' && this.possiblePushTypes.includes(currPushType.toUpperCase());
        var /** @type {?} */ pushType = isValidPush ? currPushType.toUpperCase() : 'FCM';
        return pushType;
    };
    /**
     * @return {?}
     */
    NNotificationService.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.loginSubscribe.unSubscribe();
    };
    NNotificationService.decorators = [
        { type: Injectable },
    ];
    /** @nocollapse */
    NNotificationService.ctorParameters = function () { return [
        { type: NLocalStorageService, },
        { type: NPubSubService, },
        { type: HttpClient, },
        { type: NHTTPLoaderService, },
    ]; };
    return NNotificationService;
}());
export { NNotificationService };
function NNotificationService_tsickle_Closure_declarations() {
    /** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
    NNotificationService.decorators;
    /**
     * @nocollapse
     * @type {function(): !Array<(null|{type: ?, decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>)})>}
     */
    NNotificationService.ctorParameters;
    /** @type {?} */
    NNotificationService.prototype.systemService;
    /** @type {?} */
    NNotificationService.prototype.firebaseSenderId;
    /** @type {?} */
    NNotificationService.prototype.isNotificationEnabled;
    /** @type {?} */
    NNotificationService.prototype.deviceType;
    /** @type {?} */
    NNotificationService.prototype.string;
    /** @type {?} */
    NNotificationService.prototype.resDetails;
    /** @type {?} */
    NNotificationService.prototype.deviceUUID;
    /** @type {?} */
    NNotificationService.prototype.possiblePushTypes;
    /** @type {?} */
    NNotificationService.prototype.loginSubscribe;
    /** @type {?} */
    NNotificationService.prototype.sessionStorage;
    /** @type {?} */
    NNotificationService.prototype.appName;
    /** @type {?} */
    NNotificationService.prototype.localStorageService;
    /** @type {?} */
    NNotificationService.prototype.pubSubService;
    /** @type {?} */
    NNotificationService.prototype.http;
    /** @type {?} */
    NNotificationService.prototype.bHttpLoader;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1ub3RpZmljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsic3JjL2FwcC9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy9uLW5vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFJcEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxLQUFLLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVwRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7SUFpQjFELDhCQUFvQixtQkFBeUMsRUFBVSxhQUE2QixFQUMxRixNQUEwQixXQUErQjtRQURuRSxpQkFVQztRQVZtQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXNCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQzFGLFNBQUksR0FBSixJQUFJO1FBQXNCLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjs2QkFYM0IsY0FBYyxDQUFDLFdBQVcsRUFBRTtpQ0FNOUIsQ0FBQyxNQUFNLEVBQUMsS0FBSyxDQUFDO1FBTWxELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyx1QkFB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QVksS0FBSyxXQUFXLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNySCxxQkFBSSxRQUFRLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNoRSxNQUFNLENBQUMsUUFBUSxDQUFDO0tBQ2pCOzs7O0lBRUQsMENBQVc7OztJQUFYO1FBQ0UsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztLQUNuQzs7Z0JBakxGLFVBQVU7Ozs7Z0JBVkYsb0JBQW9CO2dCQUVwQixjQUFjO2dCQUNkLFVBQVU7Z0JBR1Ysa0JBQWtCOzsrQkFYM0I7O1NBZ0JhLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9uSW5pdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOU3lzdGVtU2VydmljZSB9IGZyb20gJy4vbi1zeXN0ZW0uc2VydmljZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmRlY2xhcmUgdmFyIFB1c2hOb3RpZmljYXRpb246IGFueTtcbmRlY2xhcmUgdmFyIEFQTlNQdXNoTm90aWZpY2F0aW9uOiBhbnk7XG5pbXBvcnQgeyBOTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1sb2NhbFN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgKiBhcyBmaXJlYmFzZSBmcm9tICdmaXJlYmFzZSc7XG5pbXBvcnQgeyBOUHViU3ViU2VydmljZSB9IGZyb20gJy4vbi1wdWJTdWIuc2VydmljZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTlNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1zZXNzaW9uU3RvcmFnZS5zZXJ2aWNlJztcbi8vIGltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBOSFRUUExvYWRlclNlcnZpY2UgfSBmcm9tICcuL24tSFRUUExvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IGVudmlyb25tZW50IH0gZnJvbSAnLi4vLi4vZW52aXJvbm1lbnRzL2Vudmlyb25tZW50LnByb2QnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOTm90aWZpY2F0aW9uU2VydmljZSB7XG4gIC8vIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBOTm90aWZpY2F0aW9uU2VydmljZTtcbiAgcHJpdmF0ZSBzeXN0ZW1TZXJ2aWNlOiBOU3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gIHByaXZhdGUgZmlyZWJhc2VTZW5kZXJJZDogc3RyaW5nO1xuICBwcml2YXRlIGlzTm90aWZpY2F0aW9uRW5hYmxlZDogYm9vbGVhbjtcbiAgcHJpdmF0ZSBkZXZpY2VUeXBlOyBzdHJpbmc7XG4gIHByaXZhdGUgcmVzRGV0YWlscztcbiAgcHJpdmF0ZSBkZXZpY2VVVUlEOiBzdHJpbmc7XG4gIHByaXZhdGUgcG9zc2libGVQdXNoVHlwZXM6IHN0cmluZ1tdID0gWydBUE5TJywnRkNNJ107XG4gIGxvZ2luU3Vic2NyaWJlO1xuICBzZXNzaW9uU3RvcmFnZTogTlNlc3Npb25TdG9yYWdlU2VydmljZTtcbiAgYXBwTmFtZTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2NhbFN0b3JhZ2VTZXJ2aWNlOiBOTG9jYWxTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBwdWJTdWJTZXJ2aWNlOiBOUHViU3ViU2VydmljZSxcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgYkh0dHBMb2FkZXI6IE5IVFRQTG9hZGVyU2VydmljZSkge1xuICAgIHRoaXMuZmlyZWJhc2VTZW5kZXJJZCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2ZpcmViYXNlU2VuZGVySWQnKTtcbiAgICB0aGlzLmlzTm90aWZpY2F0aW9uRW5hYmxlZCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2lzTm90aWZpY2F0aW9uRW5hYmxlZCcpO1xuICAgIHRoaXMuYXBwTmFtZSA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2FwcE5hbWUnKTtcbiAgICB0aGlzLmRldmljZVR5cGUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZGV2aWNlVHlwZTtcbiAgICB0aGlzLnNlc3Npb25TdG9yYWdlID0gbmV3IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UoKTtcbiAgICB0aGlzLmxvZ2luU3Vic2NyaWJlID0gdGhpcy5wdWJTdWJTZXJ2aWNlLiRzdWIoJ2ZpcmViYXNlUmVnaXN0ZXInLCAoKSA9PiB7XG4gICAgICB0aGlzLmVuYWJsZU5vdGlmaWNhdGlvbigpO1xuICAgIH0pXG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgfVxuXG5cbiAgZW5hYmxlTm90aWZpY2F0aW9uKCkge1xuICAgIGxldCBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHVzaFR5cGUnKSk7XG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlcmVhZHknLCBldmVudCA9PiB7XG4gICAgICBpZiAodGhpcy5pc05vdGlmaWNhdGlvbkVuYWJsZWQpIHtcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlVHlwZSAmJiB0aGlzLmRldmljZVR5cGUgIT0gJ2Jyb3dzZXInKSB7XG4gICAgICAgICAgdGhpcy5kZXZpY2VUeXBlID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmRldmljZVR5cGU7XG4gICAgICAgICAgdGhpcy5jaGVja1Blcm1pc3Npb24ocHVzaFR5cGUpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplTm90aWZpY2F0aW9ucyhwdXNoVHlwZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAodGhpcy5pc05vdGlmaWNhdGlvbkVuYWJsZWQgJiYgcHVzaFR5cGUgIT09ICdBUE5TJykge1xuICAgICAgaWYgKHRoaXMuZGV2aWNlVHlwZSAmJiB0aGlzLmRldmljZVR5cGUgPT0gJ2Jyb3dzZXInICYmIHdpbmRvd1snTm90aWZpY2F0aW9uJ10pIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXNlV2ViUHVzaCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpc2VXZWJQdXNoKCkge1xuICAgIGNvbnN0IF9fdGhpcyA9IHRoaXM7XG4gICAgY29uc3QgbWVzc2FnaW5nID0gZmlyZWJhc2UubWVzc2FnaW5nKCk7XG5cbiAgICBtZXNzYWdpbmcucmVxdWVzdFBlcm1pc3Npb24oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gbWVzc2FnaW5nLmdldFRva2VuKCk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgIGlmICh0b2tlbikge1xuICAgICAgICAgIF9fdGhpcy5zZW5kUmVnRGV0YWlscyh0b2tlbik7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICBfX3RoaXMuYkh0dHBMb2FkZXIuYWxlcnRFcnJvcihlcnIpO1xuICAgICAgfSk7XG5cbiAgICBtZXNzYWdpbmcub25NZXNzYWdlKGZ1bmN0aW9uIChwYXlsb2FkKSB7XG4gICAgICBpZiAocGF5bG9hZFsnbm90aWZpY2F0aW9uJ10pIHtcbiAgICAgICAgbGV0IG5vdGlmaWNhdGlvbk9iaiA9IHBheWxvYWRbJ25vdGlmaWNhdGlvbiddO1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICBib2R5OiBub3RpZmljYXRpb25PYmouYm9keSxcbiAgICAgICAgICBpY29uOiBub3RpZmljYXRpb25PYmouaWNvblxuICAgICAgICB9XG4gICAgICAgIC8vIGNyZWF0aW5nIGEgbmF0aXZlIGJyb3dzZXIgbWVzc2FnZVxuICAgICAgICBsZXQgbm90aWZpY2F0aW9uVUkgPSBuZXcgTm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbk9iai50aXRsZSwgb3B0aW9ucyk7XG4gICAgICAgIG5vdGlmaWNhdGlvblVJLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgd2luZG93LmZvY3VzKCk7IC8vIHdpbmRvdyBpcyBmb2N1c2VkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIHRoZSBub3RpZmljYXRpb24gdXNpbmcgdGhpc1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBjaGVja1Blcm1pc3Npb24ocHVzaFR5cGU/KSB7XG4gICAgLy8gQW5kcm9pZCAmIGlPUyBvbmx5XG4gICAgLy8gQ2hlY2tzIHdoZXRoZXIgdGhlIHB1c2ggbm90aWZpY2F0aW9uIHBlcm1pc3Npb24gaGFzIGJlZW4gZ3JhbnRlZC5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZShwdXNoVHlwZSk7XG4gICAgICBpZiAoKHRoaXMuZGV2aWNlVHlwZSA9PT0gJ0FuZHJvaWQnIHx8IHRoaXMuZGV2aWNlVHlwZSA9PT0gJ2lPUycpICYmIChwdXNoVHlwZSA9PT0gJ0ZDTScgKSkge1xuICAgICAgICBQdXNoTm90aWZpY2F0aW9uLmhhc1Blcm1pc3Npb24oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhLmlzRW5hYmxlZCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmRldmljZVR5cGUgPT09ICdpT1MnICYmIHB1c2hUeXBlID09PSAnQVBOUycpIHtcbiAgICAgICAgIEFQTlNQdXNoTm90aWZpY2F0aW9uLmhhc1Blcm1pc3Npb24oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhLmlzRW5hYmxlZCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUodHJ1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBpbml0aWFsaXplTm90aWZpY2F0aW9ucyhwdXNoVHlwZT8pIHtcbiAgICAvL3B1c2hUeXBlID0gcHVzaFR5cGUgPyBwdXNoVHlwZSA6ICdGQ00nO1xuICAgIHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZShwdXNoVHlwZSk7XG5cbiAgICBsZXQgcHVzaDtcbiAgICAvLyBEZWZhdWx0IGlmIGZvciBGQ01cbiAgICBpZiAocHVzaFR5cGUgPT09ICdGQ00nKSB7XG4gICAgICBwdXNoID0gd2luZG93WydQdXNoTm90aWZpY2F0aW9uJ10uaW5pdCh7XG4gICAgICAgIGFuZHJvaWQ6IHtcbiAgICAgICAgICBzZW5kZXJJRDogdGhpcy5maXJlYmFzZVNlbmRlcklkXG4gICAgICAgIH0sXG4gICAgICAgIGlvczoge1xuICAgICAgICAgIGFsZXJ0OiBcInRydWVcIixcbiAgICAgICAgICBiYWRnZTogXCJ0cnVlXCIsXG4gICAgICAgICAgc291bmQ6IFwidHJ1ZVwiLFxuICAgICAgICAgIHNlbmRlcklEOiB0aGlzLmZpcmViYXNlU2VuZGVySWRcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBOZXcgQVBOUyBwbHVnaW4gaW5pdFxuICAgIGVsc2UgaWYgKHB1c2hUeXBlID09PSAnQVBOUycpIHtcbiAgICAgIHB1c2ggPSB3aW5kb3dbJ0FQTlNQdXNoTm90aWZpY2F0aW9uJ10uaW5pdCh7XG4gICAgICAgIGlvczoge1xuICAgICAgICAgIGFsZXJ0OiBcInRydWVcIixcbiAgICAgICAgICBiYWRnZTogXCJ0cnVlXCIsXG4gICAgICAgICAgc291bmQ6IFwidHJ1ZVwiXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBwdXNoLm9uKCdyZWdpc3RyYXRpb24nLCAoZGF0YSkgPT4ge1xuICAgICAgLy8gZGF0YS5yZWdpc3RyYXRpb25JZFxuICAgICAgdGhpcy5zZW5kUmVnRGV0YWlscyhkYXRhLnJlZ2lzdHJhdGlvbklkKTtcbiAgICB9KTtcblxuICAgIC8vIFRvRG8gQ2hyaXN0eSBnZXQgY2FsbCBiYWNrIGZ1bmN0aW9uIGZyb20gYXBwIHVzZXIgdG8gY2hhbmdlIHdoYXQgaGFwcGVucyBvbmNlIGEgbm90aWZpY2F0aW9uIGFycml2ZXNcbiAgICBwdXNoLm9uKCdub3RpZmljYXRpb24nLCAoZGF0YSkgPT4ge1xuICAgICAgd2luZG93Wydjb3Jkb3ZhJ10ucGx1Z2lucy5ub3RpZmljYXRpb24ubG9jYWwuc2NoZWR1bGUoe1xuICAgICAgICB0aXRsZTogZGF0YS50aXRsZSxcbiAgICAgICAgdGV4dDogZGF0YS5tZXNzYWdlLFxuICAgICAgICBzb3VuZDogZGF0YS5zb3VuZCxcbiAgICAgICAgYXQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHB1c2gub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICAgIC8vIGUubWVzc2FnZVxuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHNlbmRSZWdEZXRhaWxzKHJlZ2lzdHJhdGlvbklkKSB7XG4gICAgdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLnNldFZhbHVlKCdyZWdpc3RyYXRpb25JZCcsIHJlZ2lzdHJhdGlvbklkKTtcbiAgICB2YXIgdXJsID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFRlbmFudFVybCgpICsgJ25vdGlmaWNhdGlvbi8nICsgdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnYXBwTmFtZScpICsgJy9yZWdpc3Rlcic7XG4gICAgbGV0IHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZSh0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwdXNoVHlwZScpKTtcbiAgICB0aGlzLmh0dHAucG9zdCh1cmwsIHtcbiAgICAgICdrZXknOiB0aGlzLnNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCd1c2VyT2JqJylbJ3VzZXJLZXknXSxcbiAgICAgICd1dWlkJzogdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlKCd1dWlkJyksIFxuICAgICAgJ2ZicmVnaWQnOiByZWdpc3RyYXRpb25JZCxcbiAgICAgICdwdXNoVHlwZSc6IHB1c2hUeXBlXG4gICAgfSkuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICAvLyB0aGlzLnB1YlN1YlNlcnZpY2UuJHB1YignRkJSZWdDb21wJyk7XG4gICAgfSwgZXJyb3IgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgIH0pXG4gIH1cblxuICBnZXRQdXNoVHlwZSAoY3VyclB1c2hUeXBlKSB7XG4gICAgbGV0IGlzVmFsaWRQdXNoID0gdHlwZW9mIGN1cnJQdXNoVHlwZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdGhpcy5wb3NzaWJsZVB1c2hUeXBlcy5pbmNsdWRlcyhjdXJyUHVzaFR5cGUudG9VcHBlckNhc2UoKSk7XG4gICAgbGV0IHB1c2hUeXBlID0gaXNWYWxpZFB1c2ggPyBjdXJyUHVzaFR5cGUudG9VcHBlckNhc2UoKSA6ICdGQ00nO1xuICAgIHJldHVybiBwdXNoVHlwZTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMubG9naW5TdWJzY3JpYmUudW5TdWJzY3JpYmUoKTtcbiAgfVxuICBcbn1cbiJdfQ==